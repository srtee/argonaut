// Built with esbuild

var Cn=Object.defineProperty;var f=(t,e)=>()=>(t&&(e=t(t=0)),e);var R=(t,e)=>{for(var o in e)Cn(t,o,{get:e[o],enumerable:!0})};var Nt={};R(Nt,{WORKER_BASE_URL:()=>j,state:()=>r,store:()=>b});var Do,j,Dn,ht,ko,Co,L,b,r,T=f(()=>{Do="appState",j="https://argonaut-github-proxy.shernren.workers.dev",Dn={papersData:{},selectedTags:new Set,processedPapersData:[],currentEditingKey:null,tentativeTags:[],tentativeTagsRemoved:[]},ht=new Set,ko=t=>{try{let e={...t,selectedTags:Array.from(t.selectedTags)};sessionStorage.setItem(Do,JSON.stringify(e))}catch(e){console.warn("Failed to persist state:",e)}},Co=()=>{try{let t=sessionStorage.getItem(Do);return t?JSON.parse(t):{}}catch(t){return console.warn("Failed to load state from storage:",t),{}}},L={...Dn,...Co(),selectedTags:new Set(Co().selectedTags||[])},b={get:()=>({...L}),set:t=>{L={...L,...t},ko(L),ht.forEach(e=>e(L))},setSelectedTags:t=>{L={...L,selectedTags:new Set(t)},ko(L),ht.forEach(e=>e(L))},subscribe:t=>(ht.add(t),t(L),()=>ht.delete(t))},r=new Proxy({},{get(t,e){return L[e]},set(t,e,o){return console.warn(`Direct mutation of state.${e} is discouraged. Use store.set() instead.`),L[e]=o,!0}})});function bt(t,e){Go.set(t,e),console.log(`[DOM Registry] Registered ${Object.keys(e).length} elements for module: ${t}`)}function m(t){return yt.get(t)||null}function G(...t){let e={};for(let o of t)e[o]=yt.get(o)||null;return e}function Ao(){console.log("[DOM Registry] Initializing all DOM elements..."),Gn(),An(),$n(),Pn(),Rn(),console.log("[DOM Registry] Initialization complete")}function Gn(){bt("ui",{loadJsonSection:document.getElementById("loadJsonSection"),saveJsonSection:document.getElementById("saveJsonSection"),papersSection:document.getElementById("papersSection"),exportResetSection:document.getElementById("exportResetSection"),papersList:document.getElementById("papersList"),fileInput:document.getElementById("fileInput"),urlInput:document.getElementById("urlInput"),loadUrlBtn:document.getElementById("loadUrlBtn"),loadFromStorageBtn:document.getElementById("loadFromStorageBtn"),loadNewBtn:document.getElementById("loadNewBtn"),saveToStorageBtn:document.getElementById("saveToStorageBtn"),exportJsonBtn:document.getElementById("exportJsonBtn"),exportBibtexAllBtn:document.getElementById("exportBibtexAllBtn"),exportBibtexTaggedBtn:document.getElementById("exportBibtexTaggedBtn"),jsonFormatSelector:document.getElementById("jsonFormatSelector"),error:document.getElementById("error"),status:document.getElementById("status"),themeToggle:document.getElementById("themeToggle"),onboardingModal:document.getElementById("onboardingModal"),closeOnboardingBtn:document.getElementById("closeOnboardingBtn"),showOnboardingBtn:document.getElementById("showOnboardingBtn"),onboardingNextBtn:document.getElementById("onboardingNextBtn"),onboardingBackBtn:document.getElementById("onboardingBackBtn"),onboardingCompleteBtn:document.getElementById("onboardingCompleteBtn")})}function An(){bt("auth",{githubSection:document.getElementById("githubSection"),githubNotLoggedIn:document.getElementById("githubNotLoggedIn"),githubLoggedIn:document.getElementById("githubLoggedIn"),githubConnectBtn:document.getElementById("githubConnectBtn"),githubLogoutBtn:document.getElementById("githubLogoutBtn"),githubUserAvatar:document.getElementById("githubUserAvatar"),githubUserName:document.getElementById("githubUserName"),gistConnectedContent:document.getElementById("gistConnectedContent"),saveGistConnectedContent:document.getElementById("saveGistConnectedContent")})}function $n(){bt("papers",{papersList:document.getElementById("papersList"),loadJsonSection:document.getElementById("loadJsonSection"),saveJsonSection:document.getElementById("saveJsonSection"),exportResetSection:document.getElementById("exportResetSection"),papersSection:document.getElementById("papersSection"),doiInput:document.getElementById("doiInput"),doiKeyInput:document.getElementById("doiKeyInput"),addDoiBtn:document.getElementById("addDoiBtn"),status:document.getElementById("status"),exportBibtexTaggedBtn:document.getElementById("exportBibtexTaggedBtn")})}function Pn(){bt("github",{loadGistSelector:document.getElementById("loadGistSelector"),saveGistSelector:document.getElementById("saveGistSelector"),loadFromGistCollectionBtn:document.getElementById("loadFromGistCollectionBtn"),saveToGistOptionBtn:document.getElementById("saveToGistOptionBtn"),gistConnectedContent:document.getElementById("gistConnectedContent"),saveGistConnectedContent:document.getElementById("saveGistConnectedContent"),jsonFormatSelector:document.getElementById("jsonFormatSelector")})}function Rn(){let t=0;for(let[e,o]of Go)for(let[n,s]of Object.entries(o))s?yt.set(n,s):(console.warn(`[DOM Registry] Missing element: #${n} (module: ${e})`),t++);t>0&&console.warn(`[DOM Registry] ${t} element(s) missing from DOM`),console.log(`[DOM Registry] ${yt.size} elements registered`)}var yt,Go,_=f(()=>{yt=new Map,Go=new Map});async function Ft(t,e={}){let o={headers:{Accept:"application/json",...e.headers},credentials:"include",...e};return body instanceof FormData&&delete o.headers["Content-Type"],await fetch(t,o)}async function k(t,e={}){let o=await Ft(t,{...e,headers:{"Content-Type":"application/json",Accept:"application/json",...e.headers}});if(!o.ok){let n=`Request failed with status ${o.status}`;try{let s=await o.json();n=s.error||s.message||n}catch{}throw new Error(n)}return o.json()}async function Jt(t,e={}){let o=await Ft(t,e);if(!o.ok)throw new Error(`Request failed with status ${o.status}`);return o.text()}var M=f(()=>{});async function vt(t){try{return await Jt(`${jn}/${encodeURIComponent(t)}`,{headers:{Accept:"application/x-bibtex"}})}catch(e){return console.error("[DOIClient] Error fetching BibTeX:",e),null}}var jn,$o=f(()=>{M();jn="https://doi.org"});async function St(t){try{let e=await k(`${Mn}/DOI:${encodeURIComponent(t)}?fields=abstract`);return e.abstract?e.abstract:null}catch(e){return console.error("[SemanticScholarClient] Error fetching abstract:",e),null}}var Mn,Po=f(()=>{M();Mn="https://api.semanticscholar.org/graph/v1/paper"});async function xt(t){try{let e=await k(`${Ro}/${encodeURIComponent(t)}`);return e.message&&e.message.abstract?e.message.abstract:null}catch(e){return console.error("[CrossrefClient] Error fetching abstract:",e),null}}async function wt(t){try{let e=await k(`${Ro}/${encodeURIComponent(t)}`);if(e.message){if(e.message.page)return e.message.page;if(e.message["article-number"])return e.message["article-number"]}return null}catch(e){return console.error("[CrossrefClient] Error fetching pages:",e),null}}var Ro,jo=f(()=>{M();Ro="https://api.crossref.org/works"});function E(){return localStorage.getItem("github_session_id")}function Et(t){localStorage.setItem("github_session_id",t)}function _t(){localStorage.removeItem("github_session_id")}function Mo(){let t={},e=E();return e&&(t.Authorization=`Bearer ${e}`),t}async function qt(){try{let t=await fetch(`${j}/session`,{headers:Mo(),credentials:"include"});return t.ok?await t.json():{authenticated:!1}}catch(t){return console.error("[AuthClient] Error checking session:",t),{authenticated:!1}}}async function Kt(){window.location.href=`${j}/login`}async function Xt(){let t=E();try{await fetch(`${j}/logout`,{method:"POST",headers:Mo(),credentials:"include"})}catch(e){console.error("[AuthClient] Error logging out:",e)}_t(),localStorage.removeItem("github_selected_gist")}var zt=f(()=>{M();T()});function Tt(){let t={},e=E();return e&&(t.Authorization=`Bearer ${e}`),t}async function Vt(){try{return await k(Bt,{headers:Tt()})}catch(t){throw console.error("[GitHubClient] Error listing gists:",t),t}}async function Wt(t){try{return await k(`${Bt}/${t}`,{headers:Tt()})}catch(e){throw console.error("[GitHubClient] Error getting gist:",e),e}}async function Yt(t,e="Argonaut Papers"){try{return await k(Bt,{method:"POST",headers:Tt(),body:JSON.stringify({description:e,public:!1,files:t})})}catch(o){throw console.error("[GitHubClient] Error creating gist:",o),o}}async function Qt(t,e,o="Argonaut Papers"){try{return await k(`${Bt}/${t}`,{method:"PATCH",headers:Tt(),body:JSON.stringify({description:o,files:e})})}catch(n){throw console.error("[GitHubClient] Error updating gist:",n),n}}var Bt,Uo=f(()=>{M();zt();T();Bt=`${j}/api/github/gists`});var It=f(()=>{M();$o();Po();jo();zt();Uo()});function ne(){Zt=m("themeToggle"),te=document.querySelector(".theme-toggle__icon--sun"),ee=document.querySelector(".theme-toggle__icon--moon")}function se(t){te&&(te.style.display=t?"block":"none"),ee&&(ee.style.display=t?"none":"block")}function Ho(){return window.matchMedia("(prefers-color-scheme: dark)").matches}function No(){let t=localStorage.getItem(oe);return t==="dark"?"dark":t==="light"?"light":null}function Lt(t){let e=t==="dark";e?document.documentElement.setAttribute("data-theme","dark"):document.documentElement.removeAttribute("data-theme"),localStorage.setItem(oe,t),se(e)}function ie(){let t=No();if(t)Lt(t);else{let e=Ho();e?document.documentElement.setAttribute("data-theme","dark"):document.documentElement.removeAttribute("data-theme"),se(e)}}function re(){Zt&&Zt.addEventListener("click",()=>{let e=document.documentElement.getAttribute("data-theme")==="dark"?"light":"dark";Lt(e)}),window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",t=>{localStorage.getItem(oe)||Lt(t.matches?"dark":"light")})}var Zt,te,ee,oe,ae=f(()=>{_();oe="theme"});function ce(){Z=m("error"),Ot=m("status")}function Un(t){if(!t)return"";let e=document.createElement("div");return e.textContent=t,e.innerHTML}function h(t){Z.textContent=t,Z.classList.add("error--visible"),setTimeout(()=>{Z.classList.remove("error--visible")},5e3)}function x(t){Ot.textContent=t,Ot.classList.add("status--visible")}function N(){Ot.classList.remove("status--visible")}function le(){Z.classList.remove("error--visible")}var Z,Ot,A=f(()=>{_()});var v={};R(v,{addPagesToBibTeX:()=>Nn,addPaperByDoi:()=>ge,applyTagFilter:()=>xe,createPaperCard:()=>qo,displayPapers:()=>Fn,fetchAbstract:()=>ve,fetchAbstractFromCrossref:()=>xt,fetchAbstractFromSemanticScholar:()=>St,fetchPagesFromCrossref:()=>wt,formatAuthors:()=>ue,generateDefaultKey:()=>Jo,hasSelectedTag:()=>Ct,initDOM:()=>be,initEventListeners:()=>we,parseBibTeX:()=>Se,processPapers:()=>Ko,renderPapers:()=>Xo,updateTagVisuals:()=>zo});function be(){let t=G("papersList","loadJsonSection","saveJsonSection","exportResetSection","papersSection","doiInput","doiKeyInput","addDoiBtn","status","exportBibtexTaggedBtn");kt=t.papersList,me=t.loadJsonSection,fe=t.saveJsonSection,he=t.exportResetSection,ye=t.papersSection,tt=t.doiInput,de=t.doiKeyInput,pe=t.addDoiBtn,Fo=t.status,Hn=t.exportBibtexTaggedBtn,console.log("[Papers] DOM elements initialized")}async function ve(t){let e=await St(t);return e||(e=await xt(t),e)}function Nn(t,e){if(!e)return t;let o=/pages\s*=\s*(?:\{([^}]*)\}|"([^"]*)")/i,n=t.match(o);if(n){let s=n[1]||n[2];return t.replace(n[0],`pages = {${e}}`)}else{let s=/year\s*=\s*(?:\{([^}]*)\}|"([^"]*)")/i,i=t.match(s);if(i)return t.replace(i[0],`${i[0]},
  pages = {${e}}`);{let c=/(\w+)\s*=\s*(?:\{([^}]*)\}|"([^"]*)")/,a=t.match(c);if(a)return t.replace(a[0],`${a[0]},
  pages = {${e}}`)}}return t}function Se(t){let e={title:"",author:"",journal:"",year:"",month:"",volume:"",number:"",pages:""},o=/(\w+)\s*=\s*(?:\{([^}]*)\}|"([^"]*)")/g,n;for(;(n=o.exec(t))!==null;){let s=n[1].toLowerCase(),i=n[2]||n[3];e.hasOwnProperty(s)&&(e[s]=i)}return e}function ue(t){return t?t.split(/\s+and\s+/i).map(e=>{let o=e.split(",").map(n=>n.trim()).filter(n=>n);return o.length>=2?`${o[1]} ${o[0]}`:e.trim()}).join(", "):"Unknown authors"}function Jo(t){let e=t.author||"",o=t.year||"",i=((e.split(/\s+and\s+/i)[0]||"").split(",")[0]?.trim()||"Unknown").replace(/[^a-zA-Z]/g,""),c=i.charAt(0).toUpperCase()+i.slice(1).toLowerCase()+o,a=c,l=1,p=Object.keys(r.papersData);for(;p.includes(a);)a=c+String.fromCharCode(96+l),l++;return a}async function ge(){let t=tt.value.trim(),e=de.value.trim();if(!t){let{showError:n}=await Promise.resolve().then(()=>(g(),u));n("Please enter a DOI or URL");return}let o=extractDOI(t);if(!o){let{showError:n}=await Promise.resolve().then(()=>(g(),u));n("Could not extract a valid DOI from the input. Please enter a valid DOI (e.g., 10.xxxx/xxxx) or a URL containing a DOI.");return}try{let{showStatus:n}=await Promise.resolve().then(()=>(g(),u));n(`Fetching paper: ${o}...`);let s=await vt(o);if(!s){let{showError:p}=await Promise.resolve().then(()=>(g(),u));p("Failed to fetch BibTeX for this DOI");return}let i=Se(s),c=e||Jo(i);if(r.papersData[c]&&!e){let{showError:p}=await Promise.resolve().then(()=>(g(),u));p(`Paper "${c}" already exists. Please provide a custom key or use a different DOI.`);return}else if(r.papersData[c]&&e&&!confirm(`The key "${c}" already exists. Do you want to overwrite the existing entry?`)){let{hideStatus:p}=await Promise.resolve().then(()=>(g(),u));p();return}let a=await ve(o);b.set({papersData:{...r.papersData,[c]:{_doi:o,...i.title&&{title:i.title},...i.author&&{author:i.author},...i.journal&&{journal:i.journal},...i.year&&{year:i.year},...i.volume&&{volume:i.volume},...i.number&&{number:i.number},...i.pages&&{pages:i.pages}}}});let l={key:c,paper:{_doi:o,...i.title&&{title:i.title},...i.author&&{author:i.author},...i.journal&&{journal:i.journal},...i.year&&{year:i.year},...i.volume&&{volume:i.volume},...i.number&&{number:i.number},...i.pages&&{pages:i.pages}},bibInfo:{title:i.title||c,...i},abstract:a};b.set({processedPapersData:[...r.processedPapersData,l]}),xe(),Object.keys(r.papersData).length===1&&(me.style.display="none",fe.style.display="block",he.style.display="block",ye.style.display="block"),tt.value="",de.value="",n(`Paper "${c}" added successfully`),setTimeout(()=>{let p=document.querySelector(`.paper[data-key="${c}"]`);p&&(p.scrollIntoView({behavior:"smooth",block:"center"}),p.classList.add("paper--highlight"),setTimeout(()=>p.classList.remove("paper--highlight"),2e3))},100)}catch(n){console.error("Error adding paper:",n);let{showError:s}=await Promise.resolve().then(()=>(g(),u));s("Error adding paper: "+n.message)}}function qo(t,e,o,n){let s=document.createElement("article");s.className="paper",s.dataset.key=t;let i=y=>{if(!y)return"";let D=document.createElement("div");return D.textContent=y,D.innerHTML},c=(e._tags||[]).map(y=>`<button type="button" class="tag" data-tag="${y}" aria-pressed="false" tabindex="0">${y}</button>`).join(""),a=(e._alsoread||[]).map(y=>`<button type="button" class="also-read__link" data-ref="${y}" tabindex="0" aria-label="View paper: ${y}">${y}</button>`).join(""),l=`<textarea class="comments" placeholder="Add your notes..." data-key="${t}" aria-label="Notes for this paper">${e._comments||""}</textarea>`,p=n?`<div class="abstract__content">${i(n)}</div>`:'<p class="abstract__empty">No abstract available</p>',d=[];ue(o.author)&&d.push(`<span class="citation__authors">${ue(o.author)}</span>`),i(o.journal)&&d.push(`<span class="citation__journal">${i(o.journal)}</span>`),o.year&&d.push(`<span class="citation__year">${o.year}</span>`),o.volume&&d.push(`<span class="citation__volume">Vol. ${o.volume}</span>`),o.number&&d.push(`<span class="citation__number">No. ${o.number}</span>`),o.pages&&d.push(`<span class="citation__pages">pp. ${o.pages}</span>`),e._doi&&d.push(`<a href="https://doi.org/${e._doi}" target="_blank" rel="noopener noreferrer" class="citation__link">DOI: ${e._doi}</a>`);let C=d.join(" ");s.innerHTML=`
        <div class="paper__header">
            <h3 class="paper__title">${i(o.title||t)}</h3>
        </div>
        <p class="citation">${C}</p>
        ${l}
        <div class="tags">
            <button class="tag-edit-btn" aria-label="Edit tags" type="button" data-key="${t}">
                <svg class="tag-edit-btn__icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                    <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path>
                </svg>
            </button>
            ${c}
        </div>
        ${a?`<div class="also-read" role="group" aria-label="Also read papers"><span class="also-read__label">Also read:</span> ${a}</div>`:""}
        <button class="abstract-toggle" aria-expanded="false" aria-label="Toggle abstract" type="button">
            <svg class="abstract-toggle__icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                <path d="M6 9l6 6 6-6"/>
            </svg>
            Abstract
        </button>
        <div class="abstract" aria-hidden="true">
            ${p}
        </div>
    `;let w=s.querySelector(".abstract-toggle"),Oo=s.querySelector(".abstract");return w.addEventListener("click",()=>{let y=w.getAttribute("aria-expanded")==="true";w.setAttribute("aria-expanded",!y),Oo.classList.toggle("abstract--expanded"),Oo.setAttribute("aria-hidden",y),w.querySelector("svg").style.transform=y?"rotate(0deg)":"rotate(180deg)"}),s.querySelectorAll(".also-read__link").forEach(y=>{let D=()=>{let I=y.dataset.ref,Q=document.querySelector(`.paper[data-key="${I}"]`);Q?(Q.scrollIntoView({behavior:"smooth",block:"center"}),Q.classList.add("paper--highlight"),Q.focus(),setTimeout(()=>Q.classList.remove("paper--highlight"),2e3)):Promise.resolve().then(()=>(g(),u)).then(({showError:kn})=>{kn(`Paper "${I}" not found in current view`)})};y.addEventListener("click",D),y.addEventListener("keydown",I=>{(I.key==="Enter"||I.key===" ")&&(I.preventDefault(),D())})}),s.querySelectorAll(".tag").forEach(y=>{let D=()=>{Promise.resolve().then(()=>(g(),u)).then(({toggleTag:I})=>{I(y.dataset.tag)})};y.addEventListener("click",D),y.addEventListener("keydown",I=>{(I.key==="Enter"||I.key===" ")&&(I.preventDefault(),D())})}),s}async function Ko(t){b.set({papersData:t});let e=Object.entries(t),{showStatus:o}=await Promise.resolve().then(()=>(g(),u));o(`Processing ${e.length} papers...`),await new Promise(s=>setTimeout(s,0));let n=[];for(let s=0;s<e.length;s++){let[i,c]=e[s];Fo.textContent=`Fetching ${s+1} of ${e.length}: ${i}`,await new Promise(l=>setTimeout(l,0));let a={key:i,paper:c,bibInfo:{title:i},abstract:null};if(c._doi){let l=await vt(c._doi);if(l){a.bibInfo=Se(l);let d=a.bibInfo.pages;d||(d=await wt(c._doi),d&&(a.bibInfo.pages=d))}let p=await ve(c._doi);p&&(a.abstract=p)}n.push(a),s<e.length-1&&await new Promise(l=>setTimeout(l,1e3))}return n}async function Fn(){let t=await Ko(r.papersData);Xo(t),me.style.display="none",ye.style.display="block",fe.style.display="block",he.style.display="block"}function Xo(t){b.set({processedPapersData:t}),xe()}function xe(){if(kt.innerHTML="",r.processedPapersData.length===0){kt.innerHTML='<p class="no-papers">No papers found in the loaded data.</p>';return}[...r.processedPapersData].sort((e,o)=>{let n=Ct(e.paper),s=Ct(o.paper);return n&&!s?-1:!n&&s?1:0}).forEach(({key:e,paper:o,bibInfo:n,abstract:s})=>{let i=qo(e,o,n,s);r.selectedTags.size>0&&!Ct(o)&&i.classList.add("paper--dimmed"),kt.appendChild(i)}),zo(),Promise.resolve().then(()=>(g(),u)).then(({updateExportButtonStates:e})=>{e()})}function Ct(t){let e=t._tags||[];return r.selectedTags.size===0?!0:e.some(o=>r.selectedTags.has(o))}function zo(){document.querySelectorAll(".tag").forEach(t=>{let e=t.dataset.tag;r.selectedTags.size===0?(t.classList.remove("tag--selected","tag--deselected"),t.setAttribute("aria-pressed","false")):r.selectedTags.has(e)?(t.classList.add("tag--selected"),t.classList.remove("tag--deselected"),t.setAttribute("aria-pressed","true")):(t.classList.add("tag--deselected"),t.classList.remove("tag--selected"),t.setAttribute("aria-pressed","false"))})}function we(){console.log("[Papers] Initializing event listeners"),pe&&pe.addEventListener("click",()=>{ge()}),tt&&tt.addEventListener("keydown",t=>{t.key==="Enter"&&(t.preventDefault(),ge())}),console.log("[Papers] Event listeners initialized")}var kt,me,fe,he,ye,tt,de,pe,Fo,Hn,S=f(()=>{T();_();It()});function Be(){Ee=m("papersList"),_e=m("jsonFormatSelector")}function Vo(){b.set({papersData:{},selectedTags:new Set,processedPapersData:[]}),Ee&&(Ee.innerHTML="")}function Te(){if(!r.papersData||Object.keys(r.papersData).length===0){h("No papers to save");return}try{let t=_e?_e.value:"full",e=r.papersData;if(t==="light"){e={};for(let[n,s]of Object.entries(r.papersData))e[n]={_doi:s._doi,_comments:s._comments||[],_tags:s._tags||[],_alsoread:s._alsoread||[]}}let o=JSON.stringify(e);localStorage.setItem("argonautPapers",o),x("Papers saved to browser storage")}catch(t){console.error("Error saving to storage:",t),h("Error saving to storage: "+t.message)}}async function Ie(){try{let t=localStorage.getItem("argonautPapers");if(!t){h("No papers found in browser storage");return}let e=JSON.parse(t);if(!e||Object.keys(e).length===0){h("No papers found in browser storage");return}Vo(),b.set({papersData:e});let{displayPapers:o}=await Promise.resolve().then(()=>(S(),v));o(),x(`Loaded ${Object.keys(e).length} papers from browser storage`)}catch(t){console.error("Error loading from storage:",t),h("Error loading from storage: "+t.message)}}var Ee,_e,Le=f(()=>{T();A();_()});function ke(){Oe=m("jsonFormatSelector"),et=m("status")}async function ot(t,e,o){if(console.log("[Export] saveFileWithPicker called"),console.log("[Export] showSaveFilePicker in window:","showSaveFilePicker"in window),console.log("[Export] defaultFilename:",e),"showSaveFilePicker"in window){console.log("[Export] Using File System Access API");try{console.log("[Export] Calling showSaveFilePicker...");let s=await(await window.showSaveFilePicker({suggestedName:e,types:[{description:Wo(o),accept:{[o]:Yo(o)}}]})).createWritable();return await s.write(t),await s.close(),!0}catch(n){if(n.name==="AbortError")return!1;throw n}}else{let n=new Blob([t],{type:o}),s=URL.createObjectURL(n),i=document.createElement("a");return i.href=s,i.download=e,i.style.display="none",document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(s),!0}}function Wo(t){switch(t){case"application/json":return"JSON File";case"text/plain":case"text/x-bibtex":return"BibTeX File";default:return"File"}}function Yo(t){switch(t){case"application/json":return[".json"];case"text/plain":case"text/x-bibtex":return[".bib",".txt"];default:return[".*"]}}async function Ce(){if(console.log("[Export] exportJSON called"),console.log("[Export] state.papersData:",r.papersData),console.log("[Export] showSaveFilePicker available:","showSaveFilePicker"in window),!r.papersData||Object.keys(r.papersData).length===0){h("No papers to export");return}try{let t=Oe?Oe.value:"full";console.log("[Export] format:",t);let e=r.papersData,o="papers.json";if(t==="light"){e={};for(let[i,c]of Object.entries(r.papersData))e[i]={_doi:c._doi,_comments:c._comments||[],_tags:c._tags||[],_alsoread:c._alsoread||[]};o="papers-light.json"}let n=JSON.stringify(e,null,2);await ot(n,o,"application/json")&&x("JSON exported successfully")}catch(t){console.error("Error exporting JSON:",t),h("Error exporting JSON: "+t.message)}}async function Jn(){if(!r.papersData||Object.keys(r.papersData).length===0){h("No papers to export");return}try{let t={};for(let[n,s]of Object.entries(r.papersData))t[n]={_doi:s._doi,_comments:s._comments,_tags:s._tags,_alsoread:s._alsoread};let e=JSON.stringify(t,null,2);await ot(e,"papers-light.json","application/json")&&x("JSON (light) exported successfully")}catch(t){console.error("Error exporting JSON (light):",t),h("Error exporting JSON (light): "+t.message)}}async function De(){if(!r.papersData||Object.keys(r.papersData).length===0){h("No papers to export");return}try{let{fetchBibTeX:t,fetchPagesFromCrossref:e,addPagesToBibTeX:o,parseBibTeX:n}=await Promise.resolve().then(()=>(S(),v));x("Fetching BibTeX entries...");let s=Object.entries(r.papersData),i="";for(let a=0;a<s.length;a++){let[l,p]=s[a];if(et&&(et.textContent=`Fetching BibTeX ${a+1} of ${s.length}: ${l}`),await new Promise(d=>setTimeout(d,0)),p._doi){let d=await t(p._doi);if(d){let w=n(d).pages;w||(w=await e(p._doi)),w&&(d=o(d,w)),i+=d+`

`}else i+=`@misc{${l.replace(/\s+/g,"")},
  title = {${l}},
  doi = {${p._doi}}
}

`}else i+=`@misc{${l.replace(/\s+/g,"")},
  title = {${l}}
}

`;a<s.length-1&&await new Promise(d=>setTimeout(d,1e3))}await ot(i,"papers.bib","text/x-bibtex")&&x(`BibTeX exported successfully (${s.length} entries)`)}catch(t){console.error("Error exporting BibTeX:",t),h("Error exporting BibTeX: "+t.message)}}async function Ge(){if(!r.papersData||Object.keys(r.papersData).length===0){h("No papers to export");return}if(r.selectedTags.size===0){h("Please select at least one tag first");return}try{let{fetchBibTeX:t,fetchPagesFromCrossref:e,addPagesToBibTeX:o,parseBibTeX:n}=await Promise.resolve().then(()=>(S(),v));x("Fetching BibTeX entries for tagged papers...");let s=Object.entries(r.papersData).filter(([a,l])=>(l._tags||[]).some(d=>r.selectedTags.has(d)));if(s.length===0){h("No papers found with the selected tags");return}let i="";for(let a=0;a<s.length;a++){let[l,p]=s[a];if(et&&(et.textContent=`Fetching BibTeX ${a+1} of ${s.length}: ${l}`),await new Promise(d=>setTimeout(d,0)),p._doi){let d=await t(p._doi);if(d){let w=n(d).pages;w||(w=await e(p._doi)),w&&(d=o(d,w)),i+=d+`

`}else i+=`@misc{${l.replace(/\s+/g,"")},
  title = {${l}},
  doi = {${p._doi}}
}

`}else i+=`@misc{${l.replace(/\s+/g,"")},
  title = {${l}}
}

`;a<s.length-1&&await new Promise(d=>setTimeout(d,1e3))}await ot(i,"papers-tagged.bib","text/x-bibtex")&&x(`BibTeX exported successfully (${s.length} entries with selected tags)`)}catch(t){console.error("Error exporting BibTeX:",t),h("Error exporting BibTeX: "+t.message)}}var Oe,et,Ae=f(()=>{T();A();_()});function Ue(){nt=m("papersList"),Dt=m("fileInput"),$e=m("urlInput"),Pe=m("loadJsonSection"),Re=m("saveJsonSection"),je=m("exportResetSection"),Me=m("papersSection")}function Qo(t){return new Promise((e,o)=>{let n=new FileReader;n.onload=s=>{try{let i=JSON.parse(s.target.result);e(i)}catch{o(new Error("Invalid JSON file"))}},n.onerror=()=>o(new Error("Error reading file")),n.readAsText(t)})}async function Zo(t){try{let e=await fetch(t);if(!e.ok)throw new Error(`Failed to load: ${e.status}`);return await e.json()}catch(e){throw new Error(`Error loading from URL: ${e.message}`)}}async function tn(){try{let t=await fetch("papers.json");if(!t.ok)throw new Error("papers.json not found");return await t.json()}catch(t){throw new Error("Error loading default papers: "+t.message)}}async function F(t){le(),N(),nt&&(nt.innerHTML='<p class="loading">Loading papers...</p>');try{let e;switch(t){case"file":if(!Dt||!Dt.files[0])throw new Error("Please select a file");x("Loading papers from file..."),e=await Qo(Dt.files[0]);break;case"url":if(!$e)throw new Error("URL input not found");let i=$e.value.trim();if(!i)throw new Error("Please enter a URL");x("Loading papers from URL..."),e=await Zo(i);break;case"default":e=await tn();break;default:throw new Error("Invalid input method")}let{processPapers:o}=await Promise.resolve().then(()=>(S(),v)),n=await o(e),{renderPapers:s}=await Promise.resolve().then(()=>(S(),v));s(n),Pe&&(Pe.style.display="none"),Re&&(Re.style.display="block"),je&&(je.style.display="block"),Me&&(Me.style.display="block"),x(`Loaded ${n.length} papers successfully`),setTimeout(N,3e3)}catch(e){h(e.message),nt&&(nt.innerHTML="")}}var nt,Dt,$e,Pe,Re,je,Me,Gt=f(()=>{A();_()});function Ne(){He=m("urlInput")}function J(t){console.log("updateInputOptionUI: selectedValue =",t),document.querySelectorAll(".input-section__option").forEach(o=>{o.classList.remove("input-section__option--active");let n=o.querySelector(".input-section__content");n&&(n.style.display="none")});let e=document.querySelector(`.input-section__option[data-input="${t}"]`);if(console.log("updateInputOptionUI: selectedOption =",e),e){e.classList.add("input-section__option--active");let o=e.querySelector(".input-section__content");console.log("updateInputOptionUI: selectedContent =",o),o&&(o.style.display="block"),t==="gist"&&E()&&(Promise.resolve().then(()=>(it(),st)).then(({loadGistOptionsForLoadSelector:n})=>{n()}),Promise.resolve().then(()=>(q(),At)).then(({updateGistVisibility:n})=>{n()}))}}function Fe(){let t=document.querySelector('input[name="inputMethod"]:checked');if(console.log("initInputOptions: selectedRadio =",t?.id),t)J(t.value);else{let e=document.getElementById("inputMethodUrl");e&&(e.checked=!0,J("url"))}qn()}function qn(){let e=new URLSearchParams(window.location.search).get("inputURL");if(e){console.log("[URL Parameter] Found inputURL:",e),He&&(He.value=e);let o=document.getElementById("inputMethodUrl");o&&(o.checked=!0,J("url")),setTimeout(()=>{F("url")},100),window.history.replaceState({},document.title,window.location.pathname)}}var He,Je=f(()=>{q();Gt();_()});function K(t){console.log("updateSaveOptionUI: selectedValue =",t),document.querySelectorAll(".save-section__option").forEach(o=>{o.classList.remove("save-section__option--active");let n=o.querySelector(".save-section__option-content");n&&(n.style.display="none")});let e=document.querySelector(`.save-section__option[data-save="${t}"]`);if(console.log("updateSaveOptionUI: selectedOption =",e),e){e.classList.add("save-section__option--active");let o=e.querySelector(".save-section__option-content");console.log("updateSaveOptionUI: selectedContent =",o),o&&(o.style.display="block"),t==="gist"&&E()&&(Promise.resolve().then(()=>(it(),st)).then(({loadGistOptionsForSaveSelector:n})=>{n()}),Promise.resolve().then(()=>(q(),At)).then(({updateSaveGistVisibility:n})=>{n()}))}}function $t(){let t=document.querySelector('input[name="saveMethod"]:checked');if(console.log("initSaveOptions: selectedRadio =",t?.id),t)K(t.value);else{let e=document.getElementById("saveMethodFile");e&&(e.checked=!0,K("file"))}}var Pt=f(()=>{q()});var Xe={};R(Xe,{closeTagDialog:()=>X,hasUnsavedChanges:()=>jt,initTagEditorDOM:()=>Rt,openTagDialog:()=>Mt,toggleTag:()=>on,updateExportButtonStates:()=>rt});function Rt(){qe=m("exportBibtexTaggedBtn")}function rt(){qe&&(qe.disabled=r.selectedTags.size===0)}function on(t){let e=[...r.selectedTags],o=e.indexOf(t);o>-1?e.splice(o,1):e.push(t),b.setSelectedTags(e),Promise.resolve().then(()=>(S(),v)).then(({applyTagFilter:n})=>{n(),rt()})}function jt(){let t=r.papersData[r.currentEditingKey];if(!t)return!1;let e=t._tags||[],o=[...r.tentativeTags];if(e.length!==o.length)return!0;for(let n=0;n<e.length;n++)if(e[n]!==o[n])return!0;return!1}function Mt(t){if(console.log("openTagDialog called with key:",t),r.currentEditingKey!==null&&r.currentEditingKey!==t){if(jt()&&!confirm("You have unsaved changes. Discard them?"))return;X()}b.set({currentEditingKey:t});let e=r.papersData[t];if(!e){console.error("Paper not found for key:",t);return}b.set({tentativeTags:[],tentativeTagsRemoved:[]}),(e._tags||[]).forEach(i=>{let c=typeof i=="object"?JSON.stringify(i):String(i);r.tentativeTags.push(c)});let n=document.querySelector(`.paper[data-key="${t}"]`);if(n||(n=document.querySelector(`.paper-card[data-key="${t}"]`)),!n){console.error("Card not found for key:",t);return}let s=n.querySelector(".tags");if(s||(s=n.querySelector(".tags-container")),s||(s=n.querySelector('[class*="tags"]')),!s){console.error("tags not found for key:",t);return}s.classList.add("tags--editing"),s.dataset.originalContent=s.innerHTML,Ke(s)}function Ke(t){console.log("renderInlineTagEditor called");let e="";r.tentativeTags.length===0&&r.tentativeTagsRemoved.length===0?e='<p class="tag-editor__empty">No tags yet. Add your first tag above!</p>':(r.tentativeTags.forEach(s=>{e+=`<button type="button" class="tag-editor__item" data-tag="${s}" aria-label="Remove tag: ${s}">${s} <span class="tag-editor__remove">\xD7</span></button>`}),r.tentativeTagsRemoved.forEach(s=>{e+=`<button type="button" class="tag-editor__item tag-editor__item--removed" data-tag="${s}" aria-label="Restore tag: ${s}">${s} <span class="tag-editor__restore">+</span></button>`}));let o=`
        <div class="tag-editor">
            <div class="tag-editor__add">
                <input type="text" class="tag-editor__input" placeholder="Add new tag..." aria-label="New tag name">
                <button type="button" class="tag-editor__add-btn">Add</button>
            </div>
            <div class="tag-editor__list" role="list" aria-label="Tags for this paper">
                ${e}
            </div>
            <div class="tag-editor__buttons">
                <button type="button" class="tag-editor__cancel">Cancel</button>
                <button type="button" class="tag-editor__save">Save Tag Changes</button>
            </div>
        </div>
    `;t.innerHTML=o;let n=t.querySelector(".tag-editor__input");n&&n.focus(),Kn(t)}function Kn(t){console.log("setupInlineEditorListeners called");let e=t.querySelector(".tag-editor__input"),o=t.querySelector(".tag-editor__add-btn"),n=t.querySelector(".tag-editor__cancel"),s=t.querySelector(".tag-editor__save");console.log("Elements found:",{input:e,addBtn:o,cancelBtn:n,saveBtn:s}),o?o.addEventListener("click",i=>{i.stopPropagation(),en(t)}):console.error("tag-editor__add-btn not found!"),e&&e.addEventListener("keydown",i=>{i.key==="Enter"&&(i.preventDefault(),en(t))}),n&&n.addEventListener("click",()=>{jt()?confirm("You have unsaved changes. Discard them?")&&(X(),Promise.resolve().then(()=>(S(),v)).then(({applyTagFilter:i})=>{i()})):(X(),Promise.resolve().then(()=>(S(),v)).then(({applyTagFilter:i})=>{i()}))}),s&&s.addEventListener("click",Xn),t.querySelectorAll(".tag-editor__item").forEach(i=>{i.addEventListener("click",c=>{c.stopPropagation();let a=i.dataset.tag;if(i.classList.contains("tag-editor__item--removed")){let p=r.tentativeTagsRemoved.indexOf(a);p>-1&&(r.tentativeTagsRemoved.splice(p,1),r.tentativeTags.push(a))}else{let p=r.tentativeTags.indexOf(a);p>-1&&(r.tentativeTags.splice(p,1),r.tentativeTagsRemoved.push(a))}Ke(t)})})}function en(t){let e=t.querySelector(".tag-editor__input");if(!e)return;let o=e.value.trim();if(!o)return;if(r.tentativeTags.includes(o)||r.tentativeTagsRemoved.includes(o)){h("Tag already exists");return}r.tentativeTags.push(o),e.value="",Ke(t);let n=t.querySelector(".tag-editor__input");n&&n.focus()}function X({restoreContent:t=!0}={}){if(r.currentEditingKey===null)return;let e=document.querySelector(`.paper[data-key="${r.currentEditingKey}"]`);if(e||(e=document.querySelector(`.paper-card[data-key="${r.currentEditingKey}"]`)),e){let o=e.querySelector(".tags-container");o&&(o.classList.remove("editing"),t&&o.dataset.originalContent?(o.innerHTML=o.dataset.originalContent,delete o.dataset.originalContent):t||delete o.dataset.originalContent)}b.set({currentEditingKey:null,tentativeTags:[],tentativeTagsRemoved:[]})}function Xn(){if(!r.currentEditingKey)return;let t=r.papersData[r.currentEditingKey],e=[...r.tentativeTags],o=t._tags||[],n=o.filter(c=>!e.includes(c)),s=e.filter(c=>!o.includes(c)),i=`Save tag changes for "${t.title||r.currentEditingKey}"?

`;if(s.length>0&&(i+=`Adding: ${s.join(", ")}
`),n.length>0&&(i+=`Removing: ${n.join(", ")}
`),s.length===0&&n.length===0&&(i+="No changes to tags."),i+=`

This action cannot be undone.`,confirm(i)){t._tags=e;let c=r.processedPapersData.find(a=>a.key===r.currentEditingKey);c&&(c.paper=r.papersData[r.currentEditingKey]),Promise.resolve().then(()=>(S(),v)).then(({applyTagFilter:a})=>{a()}),x("Tags updated successfully")}X({restoreContent:!1})}var qe,at=f(()=>{T();A();_()});var sn={};R(sn,{saveComment:()=>nn});function nn(t,e){if(!r.papersData[t])return;let o=r.papersData[t];if((o._comments||"")!==e){o._comments=e;let s=r.processedPapersData.find(i=>i.key===t);s&&(s.paper=r.papersData[t]),console.log(`Comment saved for "${t}"`)}}var ze=f(()=>{T()});function Ye(){B=m("onboardingModal"),lt=m("onboardingBackBtn"),dt=m("onboardingNextBtn"),pt=m("onboardingCompleteBtn"),We=document.querySelectorAll(".onboarding__step"),ut=document.querySelectorAll(".onboarding__dot")}function rn(t,e,o){let n=new Date;n.setTime(n.getTime()+o*24*60*60*1e3),document.cookie=`${t}=${e};expires=${n.toUTCString()};path=/;SameSite=Lax`}function an(t){let e=`${t}=`,o=document.cookie.split(";");for(let n=0;n<o.length;n++){let s=o[n];for(;s.charAt(0)===" ";)s=s.substring(1,s.length);if(s.indexOf(e)===0)return s.substring(e.length,s.length)}return null}function cn(){return an("argonaut_onboarding_complete")==="true"}function ln(){rn("argonaut_onboarding_complete","true",365)}function Qe(){O=0,gt(),B&&(B.classList.add("onboarding--active"),B.setAttribute("aria-hidden","false"),document.body.style.overflow="hidden")}function ct(){B&&(B.classList.remove("onboarding--active"),B.setAttribute("aria-hidden","true"),document.body.style.overflow="")}function gt(){B&&(We&&We.forEach((t,e)=>{t.classList.toggle("onboarding__step--active",e===O)}),ut&&ut.forEach((t,e)=>{let o=e===O;t.classList.toggle("onboarding__dot--active",o),t.setAttribute("aria-selected",o.toString()),t.setAttribute("tabindex",o?"0":"-1")}),lt&&(lt.style.visibility=O===0?"hidden":"visible"),dt&&(dt.style.display=O===Ve-1?"none":"block"),pt&&(pt.style.display=O===Ve-1?"block":"none"),O===0&&B.focus())}function dn(){O<Ve-1&&(O++,gt())}function pn(){O>0&&(O--,gt())}function un(t){O=t,gt()}function gn(){ln(),ct()}function Ze(){cn()||setTimeout(()=>{Qe()},500)}function to(t,e){t&&t.addEventListener("click",()=>ct()),dt&&dt.addEventListener("click",dn),lt&&lt.addEventListener("click",pn),pt&&pt.addEventListener("click",gn),e&&e.addEventListener("click",Qe),ut&&ut.forEach(o=>{o.addEventListener("click",()=>{un(parseInt(o.dataset.step))})}),document.addEventListener("keydown",o=>{o.key==="Escape"&&B&&B.classList.contains("onboarding--active")&&ct()}),B&&B.addEventListener("click",o=>{o.target===B&&ct()})}var O,Ve,B,lt,dt,pt,We,ut,eo=f(()=>{_();O=0,Ve=6});var u={};R(u,{clearCurrentData:()=>Vo,closeTagDialog:()=>X,completeOnboarding:()=>gn,escapeHtml:()=>Un,exportBibTeX:()=>De,exportBibTeXTagged:()=>Ge,exportJSON:()=>Ce,exportJSONLight:()=>Jn,getCookie:()=>an,getMimeTypeDescription:()=>Wo,getMimeTypeExtensions:()=>Yo,getStoredTheme:()=>No,getSystemPreference:()=>Ho,goToStep:()=>un,hasCompletedOnboarding:()=>cn,hasUnsavedChanges:()=>jt,hideError:()=>le,hideOnboarding:()=>ct,hideStatus:()=>N,initDOM:()=>fo,initEventListeners:()=>ho,initExportDOM:()=>ke,initInputOptions:()=>Fe,initInputOptionsDOM:()=>Ne,initLoadDOM:()=>Ue,initNotificationsDOM:()=>ce,initOnboarding:()=>Ze,initOnboardingDOM:()=>Ye,initOnboardingListeners:()=>to,initSaveOptions:()=>$t,initStorageDOM:()=>Be,initTagEditorDOM:()=>Rt,initTheme:()=>ie,initThemeDOM:()=>ne,initThemeListener:()=>re,loadDefault:()=>tn,loadFromFile:()=>Qo,loadFromStorage:()=>Ie,loadFromUrl:()=>Zo,loadPapers:()=>F,markOnboardingComplete:()=>ln,nextStep:()=>dn,openTagDialog:()=>Mt,prevStep:()=>pn,saveComment:()=>nn,saveFileWithPicker:()=>ot,saveToStorage:()=>Te,setCookie:()=>rn,setTheme:()=>Lt,showError:()=>h,showOnboarding:()=>Qe,showStatus:()=>x,toggleTag:()=>on,updateExportButtonStates:()=>rt,updateInputOptionUI:()=>J,updateOnboardingUI:()=>gt,updateSaveOptionUI:()=>K,updateThemeIcons:()=>se});function fo(){ce(),ne(),Be(),ke(),Ue(),Ne(),Rt(),Ye();let t=G("loadJsonSection","saveJsonSection","papersSection","exportResetSection","papersList","fileInput","urlInput","loadUrlBtn","loadFromStorageBtn","loadNewBtn","saveToStorageBtn","exportJsonBtn","exportBibtexAllBtn","exportBibtexTaggedBtn","jsonFormatSelector","closeOnboardingBtn","showOnboardingBtn");oo=t.loadJsonSection,no=t.saveJsonSection,so=t.papersSection,io=t.exportResetSection,U=t.papersList,z=t.fileInput,ro=t.urlInput,ao=t.loadUrlBtn,co=t.loadFromStorageBtn,lo=t.loadNewBtn,po=t.saveToStorageBtn,uo=t.exportJsonBtn,go=t.exportBibtexAllBtn,mo=t.exportBibtexTaggedBtn,zn=t.jsonFormatSelector,mn=t.closeOnboardingBtn,fn=t.showOnboardingBtn,rt(),console.log("[UI] DOM elements initialized")}function ho(){console.log("[UI] Initializing event listeners"),re(),document.querySelectorAll('input[name="inputMethod"]').forEach(t=>{t.addEventListener("change",e=>{J(e.target.value)})}),document.querySelectorAll('input[name="saveMethod"]').forEach(t=>{t.addEventListener("change",()=>K(t.value))}),z&&z.addEventListener("change",()=>{z.files[0]&&F("file")}),ao&&ao.addEventListener("click",()=>F("url")),co&&co.addEventListener("click",Ie),lo&&lo.addEventListener("click",()=>{confirm(`Are you sure you want to reset all papers?

This will clear:
\u2022 All papers
\u2022 All comments
\u2022 All tags
\u2022 Any unsaved changes

This action cannot be undone.`)&&(b.setSelectedTags([]),b.set({papersData:{},processedPapersData:[]}),so&&(so.style.display="none"),no&&(no.style.display="none"),io&&(io.style.display="none"),oo&&(oo.style.display="block"),U&&(U.innerHTML=""),z&&(z.value=""),ro&&(ro.value="https://gist.githubusercontent.com/srtee/04ee671f6f27d64de800f00eb9280a21/raw/papers.json"),N())}),po&&po.addEventListener("click",Te),uo&&(console.log("[UI] Export JSON button found, adding click handler"),uo.addEventListener("click",()=>{console.log("[UI] Export JSON button clicked"),Ce()})),go&&go.addEventListener("click",De),mo&&mo.addEventListener("click",Ge),to(mn,fn),U&&U.addEventListener("click",t=>{let e=t.target.closest(".tag-edit-btn");if(e){t.stopPropagation();let o=e.dataset.key;console.log("Edit button clicked, key:",o),Mt(o)}}),document.addEventListener("keydown",async t=>{if(t.key==="Escape"&&r.currentEditingKey!==null){let{hasUnsavedChanges:e,closeTagDialog:o}=await Promise.resolve().then(()=>(at(),Xe));e()?confirm("You have unsaved changes. Discard them?")&&(o(),Promise.resolve().then(()=>(S(),v)).then(({applyTagFilter:n})=>{n()})):(o(),Promise.resolve().then(()=>(S(),v)).then(({applyTagFilter:n})=>{n()}))}}),document.addEventListener("click",t=>{if(r.currentEditingKey!==null){let e=document.querySelector(".tag-editor");e&&!e.contains(t.target)&&Promise.resolve().then(()=>(at(),Xe)).then(({hasUnsavedChanges:o,closeTagDialog:n})=>{o()?confirm("You have unsaved changes. Discard them?")&&(n(),Promise.resolve().then(()=>(S(),v)).then(({applyTagFilter:s})=>{s()})):(n(),Promise.resolve().then(()=>(S(),v)).then(({applyTagFilter:s})=>{s()}))})}}),U&&U.addEventListener("blur",t=>{if(t.target.classList.contains("comments")){let e=t.target.dataset.key,o=t.target.value;Promise.resolve().then(()=>(ze(),sn)).then(({saveComment:n})=>{n(e,o)})}},!0),console.log("[UI] Event listeners initialized")}var oo,no,so,io,U,z,ro,ao,co,lo,po,uo,go,mo,zn,mn,fn,g=f(()=>{T();_();ae();A();Le();Ae();Gt();Je();Pt();at();ze();eo();Pt();ae();A();Le();Ae();Gt();Je();Pt();at();eo();A()});var st={};R(st,{createGist:()=>yn,getGist:()=>hn,initDOM:()=>bo,listGists:()=>vo,loadFromGistCollection:()=>Sn,loadGistOptionsForLoadSelector:()=>Yn,loadGistOptionsForSaveSelector:()=>vn,saveToGistCollection:()=>xn,updateGist:()=>bn});function bo(){let t=G("loadGistSelector","saveGistSelector","loadFromGistCollectionBtn","saveToGistOptionBtn","gistConnectedContent","saveGistConnectedContent","jsonFormatSelector");$=t.loadGistSelector,P=t.saveGistSelector,V=t.loadFromGistCollectionBtn,H=t.saveToGistOptionBtn,Vn=t.gistConnectedContent,Wn=t.saveGistConnectedContent,yo=t.jsonFormatSelector,V&&V.addEventListener("click",Sn),H&&H.addEventListener("click",xn),console.log("[GitHub] DOM elements initialized")}async function vo(){return Vt()}async function hn(t){return Wt(t)}async function yn(t,e="Argonaut Papers"){return Yt(t,e)}async function bn(t,e,o="Argonaut Papers"){return Qt(t,e,o)}async function Yn(){console.log("[GitHub Gist] Loading gist options for load selector");try{let t=await vo();if($){if($.innerHTML="",t.length===0){console.log("[GitHub Gist] No gists found"),$.innerHTML='<option value="">No gists found</option>';return}t.forEach(e=>{let o=document.createElement("option");o.value=e.id;let n=e.description||Object.keys(e.files)[0]||"Unnamed gist";o.textContent=n,$.appendChild(o)}),console.log("[GitHub Gist] Loaded",t.length,"gist options for load selector")}}catch(t){console.error("[GitHub Gist] Error loading gists for load selector:",t),$&&($.innerHTML='<option value="">Failed to load gists</option>')}}async function vn(){console.log("[GitHub Gist] Loading gist options for save selector");try{let t=await vo();if(P){P.innerHTML="";let e=document.createElement("option");if(e.value="new",e.textContent="(new gist)",P.appendChild(e),t.length===0){console.log("[GitHub Gist] No existing gists found");return}t.forEach(o=>{let n=document.createElement("option");n.value=o.id;let s=o.description||Object.keys(o.files)[0]||"Unnamed gist";n.textContent=s,P.appendChild(n)}),console.log("[GitHub Gist] Loaded",t.length,"gist options for save selector")}}catch(t){console.error("[GitHub Gist] Error loading gists for save selector:",t),P&&(P.innerHTML='<option value="">Failed to load gists</option>')}}async function Sn(){console.log("[GitHub Gist] Loading from gist collection");let t=$.value;if(!t||t==="Loading gists..."||t==="No gists found"||t==="Failed to load gists"){console.log("[GitHub Gist] Invalid gist selected");let{showError:n}=await Promise.resolve().then(()=>(g(),u));n("Please select a gist to load from");return}console.log("[GitHub Gist] Loading from gist:",t),V.classList.add("loading");let{showStatus:e,hideStatus:o}=await Promise.resolve().then(()=>(g(),u));e("Loading from Gist...");try{let n=await hn(t),s=Object.values(n.files).find(C=>C.filename==="papers.json");if(!s){console.log("[GitHub Gist] No papers.json found in gist");let{showError:C}=await Promise.resolve().then(()=>(g(),u));C("Selected gist does not contain a papers.json file");let{hideStatus:w}=await Promise.resolve().then(()=>(g(),u));w(),V.classList.remove("loading");return}let i=JSON.parse(s.content);console.log("[GitHub Gist] Loaded",Object.keys(i).length,"papers from gist");let{clearCurrentData:c}=await Promise.resolve().then(()=>(g(),u));c();let{store:a}=await Promise.resolve().then(()=>(T(),Nt));a.set({papersData:i});let{processPapers:l}=await Promise.resolve().then(()=>(S(),v)),p=await l(i),{renderPapers:d}=await Promise.resolve().then(()=>(S(),v));d(p),loadJsonSection.style.display="none",saveJsonSection.style.display="block",exportResetSection.style.display="block",papersSection.style.display="block",e(`Loaded ${Object.keys(i).length} papers from Gist`),setTimeout(o,3e3),console.log("[GitHub Gist] Successfully loaded papers from gist:",t)}catch(n){console.error("[GitHub Gist] Error loading from gist:",n);let{showError:s}=await Promise.resolve().then(()=>(g(),u));s("Error loading from Gist: "+n.message);let{hideStatus:i}=await Promise.resolve().then(()=>(g(),u));i()}finally{V.classList.remove("loading")}}async function xn(){console.log("[GitHub Gist] Saving papers to gist from Save JSON Collection");let t=P.value;if(!t||t==="Loading gists..."||t==="No gists found"||t==="Failed to load gists"){console.log("[GitHub Gist] Invalid gist selected");let{showError:o}=await Promise.resolve().then(()=>(g(),u));o("Please select a gist to save to");return}H.classList.add("loading");let{showStatus:e}=await Promise.resolve().then(()=>(g(),u));e("Saving to Gist...");try{let{state:o}=await Promise.resolve().then(()=>(T(),Nt));if(!o.papersData||Object.keys(o.papersData).length===0){console.log("[GitHub Gist] No papers to save");let{showError:a}=await Promise.resolve().then(()=>(g(),u));a("No papers to save");let{hideStatus:l}=await Promise.resolve().then(()=>(g(),u));l(),H.classList.remove("loading");return}let n=yo?yo.value:"full",s=o.papersData;if(n==="light"){s={};for(let[a,l]of Object.entries(o.papersData))s[a]={_doi:l._doi,_comments:l._comments||[],_tags:l._tags||[],_alsoread:l._alsoread||[]}}let c={"papers.json":{content:JSON.stringify(s,null,2)}};if(console.log("[GitHub Gist] Saving",Object.keys(s).length,"papers"),t==="new"){console.log("[GitHub Gist] Creating new gist");let a=prompt("Enter a name for your new gist:","Argonaut Papers");if(a===null){let{hideStatus:C}=await Promise.resolve().then(()=>(g(),u));C(),H.classList.remove("loading");return}let l=a.trim()||"Argonaut Papers",p=await yn(c,l);console.log("[GitHub Gist] Created gist:",p.id);let{showStatus:d}=await Promise.resolve().then(()=>(g(),u));d("Created new Gist successfully"),await vn()}else{console.log("[GitHub Gist] Updating existing gist:",t),await bn(t,c),console.log("[GitHub Gist] Updated gist:",t);let{showStatus:a}=await Promise.resolve().then(()=>(g(),u));a("Saved to Gist successfully")}setTimeout(async()=>{let{hideStatus:a}=await Promise.resolve().then(()=>(g(),u));a()},3e3)}catch(o){console.error("[GitHub Gist] Error saving to gist:",o);let{showError:n}=await Promise.resolve().then(()=>(g(),u));n("Error saving to Gist: "+o.message);let{hideStatus:s}=await Promise.resolve().then(()=>(g(),u));s()}finally{H.classList.remove("loading")}}var $,P,V,H,Vn,Wn,yo,it=f(()=>{It();_()});var At={};R(At,{checkSession:()=>_n,clearSessionId:()=>_t,getSessionId:()=>E,initDOM:()=>_o,initEventListeners:()=>Lo,initGitHubAuth:()=>Io,initiateLogin:()=>Bn,loadGitHubAuth:()=>Ln,logout:()=>Tn,restorePapersState:()=>On,setSessionId:()=>Et,updateGistVisibility:()=>To,updateGitHubUI:()=>In,updateSaveGistVisibility:()=>Bo});function _o(){let t=G("githubSection","githubNotLoggedIn","githubLoggedIn","githubConnectBtn","githubLogoutBtn","githubUserAvatar","githubUserName","gistConnectedContent","saveGistConnectedContent","loadJsonSection","saveJsonSection","exportResetSection","papersSection");Qn=t.githubSection,Ut=t.githubNotLoggedIn,Ht=t.githubLoggedIn,W=t.githubConnectBtn,Y=t.githubLogoutBtn,So=t.githubUserAvatar,wn=t.githubUserName,mt=t.gistConnectedContent,ft=t.saveGistConnectedContent,En=t.loadJsonSection,xo=t.saveJsonSection,wo=t.exportResetSection,Eo=t.papersSection,console.log("[Auth] DOM elements initialized")}async function _n(){return qt()}async function Bn(){console.log("[GitHub Auth] Initiating login, redirecting to GitHub OAuth");let t={hasPapers:Object.keys(r.papersData).length>0,saveJsonVisible:xo?.style.display==="block",exportResetVisible:wo?.style.display==="block",papersVisible:Eo?.style.display==="block",papersData:r.papersData,processedPapersData:r.processedPapersData,selectedTags:Array.from(r.selectedTags)};sessionStorage.setItem("argonaut_oauth_state",JSON.stringify(t)),Kt()}async function Tn(){console.log("[GitHub Auth] Initiating logout"),await Xt(),Ut&&(Ut.style.display="block"),Ht&&(Ht.style.display="none"),W&&(W.style.display="block"),Y&&(Y.style.display="none"),To(),Bo(),console.log("[GitHub Auth] UI updated to logged-out state")}function In(t){console.log("[GitHub Auth] updateGitHubUI called with user:",t),Ut.style.display="none",Ht.style.display="flex",W.style.display="none",Y.style.display="inline-block",So.src=t.avatar_url,So.alt=t.login,wn.textContent=t.login,To(),Bo(),console.log("[GitHub Auth] UI updated")}function Bo(){E()?ft&&(ft.style.display="flex"):ft&&(ft.style.display="none")}function To(){E()?mt&&(mt.style.display="flex"):mt&&(mt.style.display="none")}async function Ln(){console.log("[GitHub Auth] loadGitHubAuth called");let t=await _n();if(console.log("[GitHub Auth] Session result:",t),t.authenticated&&t.user){console.log("[GitHub Auth] User authenticated, updating UI"),In(t.user);let{loadGistOptionsForLoadSelector:e}=await Promise.resolve().then(()=>(it(),st));await e()}else console.log("[GitHub Auth] User not authenticated or no user data")}async function Io(){console.log("[GitHub Auth] initGitHubAuth called");let t=new URLSearchParams(window.location.search);console.log("[GitHub Auth] URL params:",Object.fromEntries(t.entries()));let e=t.get("session_id"),o=t.get("auth");if(console.log("[GitHub Auth] Session ID from URL:",e?e.substring(0,10)+"...":"null"),console.log("[GitHub Auth] Auth status from URL:",o),e&&o==="success"){console.log("[GitHub Auth] OAuth callback received, storing session ID"),Et(e),console.log("[GitHub Auth] Session ID stored:",E()?E().substring(0,10)+"...":"null"),window.history.replaceState({},document.title,window.location.pathname);let{showStatus:n}=await Promise.resolve().then(()=>(g(),u));n("Successfully connected to GitHub");let{hideStatus:s}=await Promise.resolve().then(()=>(g(),u));setTimeout(s,3e3),await On()}else if(r.papersData&&Object.keys(r.papersData).length>0){let{displayPapers:n}=await Promise.resolve().then(()=>(S(),v));await n()}await Ln()}async function On(){let t=sessionStorage.getItem("argonaut_oauth_state");if(t)try{let e=JSON.parse(t);if(e.hasPapers){e.papersData&&b.set({papersData:e.papersData}),e.processedPapersData&&b.set({processedPapersData:e.processedPapersData}),e.selectedTags&&b.setSelectedTags(e.selectedTags),e.saveJsonVisible&&(xo.style.display="block"),e.exportResetVisible&&(wo.style.display="block"),e.papersVisible&&(Eo.style.display="block"),En.style.display="none";let{displayPapers:o}=await Promise.resolve().then(()=>(S(),v));await o()}sessionStorage.removeItem("argonaut_oauth_state")}catch(e){console.error("[GitHub Auth] Error restoring state:",e)}else if(r.papersData&&Object.keys(r.papersData).length>0){let{displayPapers:e}=await Promise.resolve().then(()=>(S(),v));await e()}}function Lo(){console.log("[Auth] Initializing event listeners"),W&&W.addEventListener("click",Bn),Y&&Y.addEventListener("click",Tn),console.log("[Auth] Event listeners initialized")}var Qn,Ut,Ht,W,Y,So,wn,mt,ft,En,xo,wo,Eo,q=f(()=>{T();_();It()});T();q();it();S();g();_();document.addEventListener("DOMContentLoaded",()=>{Ao(),fo(),_o(),bo(),be(),ho(),we(),Lo(),ie(),Io(),Fe(),$t(),Ze()});
