// Built with esbuild

var pn=Object.defineProperty;var x=(e,t)=>()=>(e&&(t=e(e=0)),t);var j=(e,t)=>{for(var o in t)pn(e,o,{get:t[o],enumerable:!0})};var Ge={};j(Ge,{WORKER_BASE_URL:()=>O,state:()=>r,store:()=>b});var go,O,un,me,po,uo,L,b,r,T=x(()=>{go="appState",O="https://argonaut-github-proxy.shernren.workers.dev",un={papersData:{},selectedTags:new Set,processedPapersData:[],currentEditingKey:null,tentativeTags:[],tentativeTagsRemoved:[]},me=new Set,po=e=>{try{let t={...e,selectedTags:Array.from(e.selectedTags)};sessionStorage.setItem(go,JSON.stringify(t))}catch(t){console.warn("Failed to persist state:",t)}},uo=()=>{try{let e=sessionStorage.getItem(go);return e?JSON.parse(e):{}}catch(e){return console.warn("Failed to load state from storage:",e),{}}},L={...un,...uo(),selectedTags:new Set(uo().selectedTags||[])},b={get:()=>({...L}),set:e=>{L={...L,...e},po(L),me.forEach(t=>t(L))},setSelectedTags:e=>{L={...L,selectedTags:new Set(e)},po(L),me.forEach(t=>t(L))},subscribe:e=>(me.add(e),e(L),()=>me.delete(e))},r=new Proxy({},{get(e,t){return L[t]},set(e,t,o){return console.warn(`Direct mutation of state.${t} is discouraged. Use store.set() instead.`),L[t]=o,!0}})});function he(e,t){mo.set(e,t),console.log(`[DOM Registry] Registered ${Object.keys(t).length} elements for module: ${e}`)}function m(e){return fe.get(e)||null}function A(...e){let t={};for(let o of e)t[o]=fe.get(o)||null;return t}function fo(){console.log("[DOM Registry] Initializing all DOM elements..."),gn(),mn(),fn(),hn(),bn(),console.log("[DOM Registry] Initialization complete")}function gn(){he("ui",{loadJsonSection:document.getElementById("loadJsonSection"),saveJsonSection:document.getElementById("saveJsonSection"),papersSection:document.getElementById("papersSection"),exportResetSection:document.getElementById("exportResetSection"),papersList:document.getElementById("papersList"),fileInput:document.getElementById("fileInput"),urlInput:document.getElementById("urlInput"),loadUrlBtn:document.getElementById("loadUrlBtn"),loadFromStorageBtn:document.getElementById("loadFromStorageBtn"),loadNewBtn:document.getElementById("loadNewBtn"),saveToStorageBtn:document.getElementById("saveToStorageBtn"),exportJsonBtn:document.getElementById("exportJsonBtn"),exportBibtexAllBtn:document.getElementById("exportBibtexAllBtn"),exportBibtexTaggedBtn:document.getElementById("exportBibtexTaggedBtn"),jsonFormatSelector:document.getElementById("jsonFormatSelector"),error:document.getElementById("error"),status:document.getElementById("status"),themeToggle:document.getElementById("themeToggle"),onboardingModal:document.getElementById("onboardingModal"),closeOnboardingBtn:document.getElementById("closeOnboardingBtn"),showOnboardingBtn:document.getElementById("showOnboardingBtn"),onboardingNextBtn:document.getElementById("onboardingNextBtn"),onboardingBackBtn:document.getElementById("onboardingBackBtn"),onboardingCompleteBtn:document.getElementById("onboardingCompleteBtn")})}function mn(){he("auth",{githubSection:document.getElementById("githubSection"),githubNotLoggedIn:document.getElementById("githubNotLoggedIn"),githubLoggedIn:document.getElementById("githubLoggedIn"),githubConnectBtn:document.getElementById("githubConnectBtn"),githubLogoutBtn:document.getElementById("githubLogoutBtn"),githubUserAvatar:document.getElementById("githubUserAvatar"),githubUserName:document.getElementById("githubUserName"),gistConnectedContent:document.getElementById("gistConnectedContent"),saveGistConnectedContent:document.getElementById("saveGistConnectedContent")})}function fn(){he("papers",{papersList:document.getElementById("papersList"),loadJsonSection:document.getElementById("loadJsonSection"),saveJsonSection:document.getElementById("saveJsonSection"),exportResetSection:document.getElementById("exportResetSection"),papersSection:document.getElementById("papersSection"),doiInput:document.getElementById("doiInput"),doiKeyInput:document.getElementById("doiKeyInput"),addDoiBtn:document.getElementById("addDoiBtn"),status:document.getElementById("status"),exportBibtexTaggedBtn:document.getElementById("exportBibtexTaggedBtn")})}function hn(){he("github",{loadGistSelector:document.getElementById("loadGistSelector"),saveGistSelector:document.getElementById("saveGistSelector"),loadFromGistCollectionBtn:document.getElementById("loadFromGistCollectionBtn"),saveToGistOptionBtn:document.getElementById("saveToGistOptionBtn"),gistConnectedContent:document.getElementById("gistConnectedContent"),saveGistConnectedContent:document.getElementById("saveGistConnectedContent"),jsonFormatSelector:document.getElementById("jsonFormatSelector")})}function bn(){let e=0;for(let[t,o]of mo)for(let[n,s]of Object.entries(o))s?fe.set(n,s):(console.warn(`[DOM Registry] Missing element: #${n} (module: ${t})`),e++);e>0&&console.warn(`[DOM Registry] ${e} element(s) missing from DOM`),console.log(`[DOM Registry] ${fe.size} elements registered`)}var fe,mo,B=x(()=>{fe=new Map,mo=new Map});function $e(){De=m("themeToggle"),Ae=document.querySelector(".theme-toggle__icon--sun"),Ce=document.querySelector(".theme-toggle__icon--moon")}function je(e){Ae&&(Ae.style.display=e?"block":"none"),Ce&&(Ce.style.display=e?"none":"block")}function ho(){return window.matchMedia("(prefers-color-scheme: dark)").matches}function bo(){let e=localStorage.getItem(Pe);return e==="dark"?"dark":e==="light"?"light":null}function be(e){let t=e==="dark";t?document.documentElement.setAttribute("data-theme","dark"):document.documentElement.removeAttribute("data-theme"),localStorage.setItem(Pe,e),je(t)}function He(){let e=bo();if(e)be(e);else{let t=ho();t?document.documentElement.setAttribute("data-theme","dark"):document.documentElement.removeAttribute("data-theme"),je(t)}}function Re(){De&&De.addEventListener("click",()=>{let t=document.documentElement.getAttribute("data-theme")==="dark"?"light":"dark";be(t)}),window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",e=>{localStorage.getItem(Pe)||be(e.matches?"dark":"light")})}var De,Ae,Ce,Pe,Me=x(()=>{B();Pe="theme"});function Ue(){Y=m("error"),ye=m("status")}function yn(e){if(!e)return"";let t=document.createElement("div");return t.textContent=e,t.innerHTML}function f(e){Y.textContent=e,Y.classList.add("error--visible"),setTimeout(()=>{Y.classList.remove("error--visible")},5e3)}function S(e){ye.textContent=e,ye.classList.add("status--visible")}function U(){ye.classList.remove("status--visible")}function Fe(){Y.classList.remove("error--visible")}var Y,ye,C=x(()=>{B()});var y={};j(y,{addPagesToBibTeX:()=>Sn,addPaperByDoi:()=>Ke,applyTagFilter:()=>tt,createPaperCard:()=>Bo,displayPapers:()=>wn,extractDOI:()=>vo,fetchAbstract:()=>Qe,fetchAbstractFromCrossref:()=>wo,fetchAbstractFromSemanticScholar:()=>So,fetchBibTeX:()=>Ze,fetchPagesFromCrossref:()=>xo,formatAuthors:()=>qe,generateDefaultKey:()=>Eo,hasSelectedTag:()=>Se,initDOM:()=>Ye,initEventListeners:()=>ot,parseBibTeX:()=>et,processPapers:()=>_o,renderPapers:()=>To,updateTagVisuals:()=>Io});function Ye(){let e=A("papersList","loadJsonSection","saveJsonSection","exportResetSection","papersSection","doiInput","doiKeyInput","addDoiBtn","status","exportBibtexTaggedBtn");ve=e.papersList,ze=e.loadJsonSection,Xe=e.saveJsonSection,Ve=e.exportResetSection,We=e.papersSection,Z=e.doiInput,Ne=e.doiKeyInput,Je=e.addDoiBtn,yo=e.status,vn=e.exportBibtexTaggedBtn,console.log("[Papers] DOM elements initialized")}function vo(e){let t=/(10\.\d{4,9}\/[-._;()/:A-Z0-9]+)/i,o=e.match(t);return o?o[1]:null}async function Ze(e){try{let t=await fetch(`https://doi.org/${encodeURIComponent(e)}`,{headers:{Accept:"application/x-bibtex"}});if(!t.ok)throw new Error(`Failed to fetch BibTeX: ${t.status}`);return await t.text()}catch(t){return console.error("Error fetching BibTeX:",t),null}}async function So(e){try{let t=await fetch(`https://api.semanticscholar.org/graph/v1/paper/DOI:${encodeURIComponent(e)}?fields=abstract`,{headers:{Accept:"application/json"}});if(!t.ok)return null;let o=await t.json();return o.abstract?o.abstract:null}catch(t){return console.error("Error fetching abstract from Semantic Scholar:",t),null}}async function wo(e){try{let t=await fetch(`https://api.crossref.org/works/${encodeURIComponent(e)}`,{headers:{Accept:"application/json"}});if(!t.ok)return null;let o=await t.json();return o.message&&o.message.abstract?o.message.abstract:null}catch(t){return console.error("Error fetching abstract from Crossref:",t),null}}async function Qe(e){let t=await So(e);return t||(t=await wo(e),t)}async function xo(e){try{let t=await fetch(`https://api.crossref.org/works/${encodeURIComponent(e)}`,{headers:{Accept:"application/json"}});if(!t.ok)return null;let o=await t.json();if(o.message){if(o.message.page)return o.message.page;if(o.message["article-number"])return o.message["article-number"]}return null}catch(t){return console.error("Error fetching pages from Crossref:",t),null}}function Sn(e,t){if(!t)return e;let o=/pages\s*=\s*(?:\{([^}]*)\}|"([^"]*)")/i,n=e.match(o);if(n){let s=n[1]||n[2];return e.replace(n[0],`pages = {${t}}`)}else{let s=/year\s*=\s*(?:\{([^}]*)\}|"([^"]*)")/i,i=e.match(s);if(i)return e.replace(i[0],`${i[0]},
  pages = {${t}}`);{let l=/(\w+)\s*=\s*(?:\{([^}]*)\}|"([^"]*)")/,a=e.match(l);if(a)return e.replace(a[0],`${a[0]},
  pages = {${t}}`)}}return e}function et(e){let t={title:"",author:"",journal:"",year:"",month:"",volume:"",number:"",pages:""},o=/(\w+)\s*=\s*(?:\{([^}]*)\}|"([^"]*)")/g,n;for(;(n=o.exec(e))!==null;){let s=n[1].toLowerCase(),i=n[2]||n[3];t.hasOwnProperty(s)&&(t[s]=i)}return t}function qe(e){return e?e.split(/\s+and\s+/i).map(t=>{let o=t.split(",").map(n=>n.trim()).filter(n=>n);return o.length>=2?`${o[1]} ${o[0]}`:t.trim()}).join(", "):"Unknown authors"}function Eo(e){let t=e.author||"",o=e.year||"",i=((t.split(/\s+and\s+/i)[0]||"").split(",")[0]?.trim()||"Unknown").replace(/[^a-zA-Z]/g,""),l=i.charAt(0).toUpperCase()+i.slice(1).toLowerCase()+o,a=l,c=1,p=Object.keys(r.papersData);for(;p.includes(a);)a=l+String.fromCharCode(96+c),c++;return a}async function Ke(){let e=Z.value.trim(),t=Ne.value.trim();if(!e){let{showError:n}=await Promise.resolve().then(()=>(g(),u));n("Please enter a DOI or URL");return}let o=vo(e);if(!o){let{showError:n}=await Promise.resolve().then(()=>(g(),u));n("Could not extract a valid DOI from the input. Please enter a valid DOI (e.g., 10.xxxx/xxxx) or a URL containing a DOI.");return}try{let{showStatus:n}=await Promise.resolve().then(()=>(g(),u));n(`Fetching paper: ${o}...`);let s=await Ze(o);if(!s){let{showError:p}=await Promise.resolve().then(()=>(g(),u));p("Failed to fetch BibTeX for this DOI");return}let i=et(s),l=t||Eo(i);if(r.papersData[l]&&!t){let{showError:p}=await Promise.resolve().then(()=>(g(),u));p(`Paper "${l}" already exists. Please provide a custom key or use a different DOI.`);return}else if(r.papersData[l]&&t&&!confirm(`The key "${l}" already exists. Do you want to overwrite the existing entry?`)){let{hideStatus:p}=await Promise.resolve().then(()=>(g(),u));p();return}let a=await Qe(o);b.set({papersData:{...r.papersData,[l]:{_doi:o,...i.title&&{title:i.title},...i.author&&{author:i.author},...i.journal&&{journal:i.journal},...i.year&&{year:i.year},...i.volume&&{volume:i.volume},...i.number&&{number:i.number},...i.pages&&{pages:i.pages}}}});let c={key:l,paper:{_doi:o,...i.title&&{title:i.title},...i.author&&{author:i.author},...i.journal&&{journal:i.journal},...i.year&&{year:i.year},...i.volume&&{volume:i.volume},...i.number&&{number:i.number},...i.pages&&{pages:i.pages}},bibInfo:{title:i.title||l,...i},abstract:a};b.set({processedPapersData:[...r.processedPapersData,c]}),tt(),Object.keys(r.papersData).length===1&&(ze.style.display="none",Xe.style.display="block",Ve.style.display="block",We.style.display="block"),Z.value="",Ne.value="",n(`Paper "${l}" added successfully`),setTimeout(()=>{let p=document.querySelector(`.paper[data-key="${l}"]`);p&&(p.scrollIntoView({behavior:"smooth",block:"center"}),p.classList.add("paper--highlight"),setTimeout(()=>p.classList.remove("paper--highlight"),2e3))},100)}catch(n){console.error("Error adding paper:",n);let{showError:s}=await Promise.resolve().then(()=>(g(),u));s("Error adding paper: "+n.message)}}function Bo(e,t,o,n){let s=document.createElement("article");s.className="paper",s.dataset.key=e;let i=h=>{if(!h)return"";let D=document.createElement("div");return D.textContent=h,D.innerHTML},l=(t._tags||[]).map(h=>`<button type="button" class="tag" data-tag="${h}" aria-pressed="false" tabindex="0">${h}</button>`).join(""),a=(t._alsoread||[]).map(h=>`<button type="button" class="also-read__link" data-ref="${h}" tabindex="0" aria-label="View paper: ${h}">${h}</button>`).join(""),c=`<textarea class="comments" placeholder="Add your notes..." data-key="${e}" aria-label="Notes for this paper">${t._comments||""}</textarea>`,p=n?`<div class="abstract__content">${i(n)}</div>`:'<p class="abstract__empty">No abstract available</p>',d=[];qe(o.author)&&d.push(`<span class="citation__authors">${qe(o.author)}</span>`),i(o.journal)&&d.push(`<span class="citation__journal">${i(o.journal)}</span>`),o.year&&d.push(`<span class="citation__year">${o.year}</span>`),o.volume&&d.push(`<span class="citation__volume">Vol. ${o.volume}</span>`),o.number&&d.push(`<span class="citation__number">No. ${o.number}</span>`),o.pages&&d.push(`<span class="citation__pages">pp. ${o.pages}</span>`),t._doi&&d.push(`<a href="https://doi.org/${t._doi}" target="_blank" rel="noopener noreferrer" class="citation__link">DOI: ${t._doi}</a>`);let G=d.join(" ");s.innerHTML=`
        <div class="paper__header">
            <h3 class="paper__title">${i(o.title||e)}</h3>
        </div>
        <p class="citation">${G}</p>
        ${c}
        <div class="tags">
            <button class="tag-edit-btn" aria-label="Edit tags" type="button" data-key="${e}">
                <svg class="tag-edit-btn__icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                    <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path>
                </svg>
            </button>
            ${l}
        </div>
        ${a?`<div class="also-read" role="group" aria-label="Also read papers"><span class="also-read__label">Also read:</span> ${a}</div>`:""}
        <button class="abstract-toggle" aria-expanded="false" aria-label="Toggle abstract" type="button">
            <svg class="abstract-toggle__icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                <path d="M6 9l6 6 6-6"/>
            </svg>
            Abstract
        </button>
        <div class="abstract" aria-hidden="true">
            ${p}
        </div>
    `;let w=s.querySelector(".abstract-toggle"),co=s.querySelector(".abstract");return w.addEventListener("click",()=>{let h=w.getAttribute("aria-expanded")==="true";w.setAttribute("aria-expanded",!h),co.classList.toggle("abstract--expanded"),co.setAttribute("aria-hidden",h),w.querySelector("svg").style.transform=h?"rotate(0deg)":"rotate(180deg)"}),s.querySelectorAll(".also-read__link").forEach(h=>{let D=()=>{let I=h.dataset.ref,W=document.querySelector(`.paper[data-key="${I}"]`);W?(W.scrollIntoView({behavior:"smooth",block:"center"}),W.classList.add("paper--highlight"),W.focus(),setTimeout(()=>W.classList.remove("paper--highlight"),2e3)):Promise.resolve().then(()=>(g(),u)).then(({showError:dn})=>{dn(`Paper "${I}" not found in current view`)})};h.addEventListener("click",D),h.addEventListener("keydown",I=>{(I.key==="Enter"||I.key===" ")&&(I.preventDefault(),D())})}),s.querySelectorAll(".tag").forEach(h=>{let D=()=>{Promise.resolve().then(()=>(g(),u)).then(({toggleTag:I})=>{I(h.dataset.tag)})};h.addEventListener("click",D),h.addEventListener("keydown",I=>{(I.key==="Enter"||I.key===" ")&&(I.preventDefault(),D())})}),s}async function _o(e){b.set({papersData:e});let t=Object.entries(e),{showStatus:o}=await Promise.resolve().then(()=>(g(),u));o(`Processing ${t.length} papers...`),await new Promise(s=>setTimeout(s,0));let n=[];for(let s=0;s<t.length;s++){let[i,l]=t[s];yo.textContent=`Fetching ${s+1} of ${t.length}: ${i}`,await new Promise(c=>setTimeout(c,0));let a={key:i,paper:l,bibInfo:{title:i},abstract:null};if(l._doi){let c=await Ze(l._doi);if(c){a.bibInfo=et(c);let d=a.bibInfo.pages;d||(d=await xo(l._doi),d&&(a.bibInfo.pages=d))}let p=await Qe(l._doi);p&&(a.abstract=p)}n.push(a),s<t.length-1&&await new Promise(c=>setTimeout(c,1e3))}return n}async function wn(){let e=await _o(r.papersData);To(e),ze.style.display="none",We.style.display="block",Xe.style.display="block",Ve.style.display="block"}function To(e){b.set({processedPapersData:e}),tt()}function tt(){if(ve.innerHTML="",r.processedPapersData.length===0){ve.innerHTML='<p class="no-papers">No papers found in the loaded data.</p>';return}[...r.processedPapersData].sort((t,o)=>{let n=Se(t.paper),s=Se(o.paper);return n&&!s?-1:!n&&s?1:0}).forEach(({key:t,paper:o,bibInfo:n,abstract:s})=>{let i=Bo(t,o,n,s);r.selectedTags.size>0&&!Se(o)&&i.classList.add("paper--dimmed"),ve.appendChild(i)}),Io(),Promise.resolve().then(()=>(g(),u)).then(({updateExportButtonStates:t})=>{t()})}function Se(e){let t=e._tags||[];return r.selectedTags.size===0?!0:t.some(o=>r.selectedTags.has(o))}function Io(){document.querySelectorAll(".tag").forEach(e=>{let t=e.dataset.tag;r.selectedTags.size===0?(e.classList.remove("tag--selected","tag--deselected"),e.setAttribute("aria-pressed","false")):r.selectedTags.has(t)?(e.classList.add("tag--selected"),e.classList.remove("tag--deselected"),e.setAttribute("aria-pressed","true")):(e.classList.add("tag--deselected"),e.classList.remove("tag--selected"),e.setAttribute("aria-pressed","false"))})}function ot(){console.log("[Papers] Initializing event listeners"),Je&&Je.addEventListener("click",()=>{Ke()}),Z&&Z.addEventListener("keydown",e=>{e.key==="Enter"&&(e.preventDefault(),Ke())}),console.log("[Papers] Event listeners initialized")}var ve,ze,Xe,Ve,We,Z,Ne,Je,yo,vn,v=x(()=>{T();B()});function it(){nt=m("papersList"),st=m("jsonFormatSelector")}function Lo(){b.set({papersData:{},selectedTags:new Set,processedPapersData:[]}),nt&&(nt.innerHTML="")}function rt(){if(!r.papersData||Object.keys(r.papersData).length===0){f("No papers to save");return}try{let e=st?st.value:"full",t=r.papersData;if(e==="light"){t={};for(let[n,s]of Object.entries(r.papersData))t[n]={_doi:s._doi,_comments:s._comments||[],_tags:s._tags||[],_alsoread:s._alsoread||[]}}let o=JSON.stringify(t);localStorage.setItem("argonautPapers",o),S("Papers saved to browser storage")}catch(e){console.error("Error saving to storage:",e),f("Error saving to storage: "+e.message)}}async function at(){try{let e=localStorage.getItem("argonautPapers");if(!e){f("No papers found in browser storage");return}let t=JSON.parse(e);if(!t||Object.keys(t).length===0){f("No papers found in browser storage");return}Lo(),b.set({papersData:t});let{displayPapers:o}=await Promise.resolve().then(()=>(v(),y));o(),S(`Loaded ${Object.keys(t).length} papers from browser storage`)}catch(e){console.error("Error loading from storage:",e),f("Error loading from storage: "+e.message)}}var nt,st,lt=x(()=>{T();C();B()});function dt(){ct=m("jsonFormatSelector"),Q=m("status")}async function ee(e,t,o){if(console.log("[Export] saveFileWithPicker called"),console.log("[Export] showSaveFilePicker in window:","showSaveFilePicker"in window),console.log("[Export] defaultFilename:",t),"showSaveFilePicker"in window){console.log("[Export] Using File System Access API");try{console.log("[Export] Calling showSaveFilePicker...");let s=await(await window.showSaveFilePicker({suggestedName:t,types:[{description:ko(o),accept:{[o]:Oo(o)}}]})).createWritable();return await s.write(e),await s.close(),!0}catch(n){if(n.name==="AbortError")return!1;throw n}}else{let n=new Blob([e],{type:o}),s=URL.createObjectURL(n),i=document.createElement("a");return i.href=s,i.download=t,i.style.display="none",document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(s),!0}}function ko(e){switch(e){case"application/json":return"JSON File";case"text/plain":case"text/x-bibtex":return"BibTeX File";default:return"File"}}function Oo(e){switch(e){case"application/json":return[".json"];case"text/plain":case"text/x-bibtex":return[".bib",".txt"];default:return[".*"]}}async function pt(){if(console.log("[Export] exportJSON called"),console.log("[Export] state.papersData:",r.papersData),console.log("[Export] showSaveFilePicker available:","showSaveFilePicker"in window),!r.papersData||Object.keys(r.papersData).length===0){f("No papers to export");return}try{let e=ct?ct.value:"full";console.log("[Export] format:",e);let t=r.papersData,o="papers.json";if(e==="light"){t={};for(let[i,l]of Object.entries(r.papersData))t[i]={_doi:l._doi,_comments:l._comments||[],_tags:l._tags||[],_alsoread:l._alsoread||[]};o="papers-light.json"}let n=JSON.stringify(t,null,2);await ee(n,o,"application/json")&&S("JSON exported successfully")}catch(e){console.error("Error exporting JSON:",e),f("Error exporting JSON: "+e.message)}}async function xn(){if(!r.papersData||Object.keys(r.papersData).length===0){f("No papers to export");return}try{let e={};for(let[n,s]of Object.entries(r.papersData))e[n]={_doi:s._doi,_comments:s._comments,_tags:s._tags,_alsoread:s._alsoread};let t=JSON.stringify(e,null,2);await ee(t,"papers-light.json","application/json")&&S("JSON (light) exported successfully")}catch(e){console.error("Error exporting JSON (light):",e),f("Error exporting JSON (light): "+e.message)}}async function ut(){if(!r.papersData||Object.keys(r.papersData).length===0){f("No papers to export");return}try{let{fetchBibTeX:e,fetchPagesFromCrossref:t,addPagesToBibTeX:o,parseBibTeX:n}=await Promise.resolve().then(()=>(v(),y));S("Fetching BibTeX entries...");let s=Object.entries(r.papersData),i="";for(let a=0;a<s.length;a++){let[c,p]=s[a];if(Q&&(Q.textContent=`Fetching BibTeX ${a+1} of ${s.length}: ${c}`),await new Promise(d=>setTimeout(d,0)),p._doi){let d=await e(p._doi);if(d){let w=n(d).pages;w||(w=await t(p._doi)),w&&(d=o(d,w)),i+=d+`

`}else i+=`@misc{${c.replace(/\s+/g,"")},
  title = {${c}},
  doi = {${p._doi}}
}

`}else i+=`@misc{${c.replace(/\s+/g,"")},
  title = {${c}}
}

`;a<s.length-1&&await new Promise(d=>setTimeout(d,1e3))}await ee(i,"papers.bib","text/x-bibtex")&&S(`BibTeX exported successfully (${s.length} entries)`)}catch(e){console.error("Error exporting BibTeX:",e),f("Error exporting BibTeX: "+e.message)}}async function gt(){if(!r.papersData||Object.keys(r.papersData).length===0){f("No papers to export");return}if(r.selectedTags.size===0){f("Please select at least one tag first");return}try{let{fetchBibTeX:e,fetchPagesFromCrossref:t,addPagesToBibTeX:o,parseBibTeX:n}=await Promise.resolve().then(()=>(v(),y));S("Fetching BibTeX entries for tagged papers...");let s=Object.entries(r.papersData).filter(([a,c])=>(c._tags||[]).some(d=>r.selectedTags.has(d)));if(s.length===0){f("No papers found with the selected tags");return}let i="";for(let a=0;a<s.length;a++){let[c,p]=s[a];if(Q&&(Q.textContent=`Fetching BibTeX ${a+1} of ${s.length}: ${c}`),await new Promise(d=>setTimeout(d,0)),p._doi){let d=await e(p._doi);if(d){let w=n(d).pages;w||(w=await t(p._doi)),w&&(d=o(d,w)),i+=d+`

`}else i+=`@misc{${c.replace(/\s+/g,"")},
  title = {${c}},
  doi = {${p._doi}}
}

`}else i+=`@misc{${c.replace(/\s+/g,"")},
  title = {${c}}
}

`;a<s.length-1&&await new Promise(d=>setTimeout(d,1e3))}await ee(i,"papers-tagged.bib","text/x-bibtex")&&S(`BibTeX exported successfully (${s.length} entries with selected tags)`)}catch(e){console.error("Error exporting BibTeX:",e),f("Error exporting BibTeX: "+e.message)}}var ct,Q,mt=x(()=>{T();C();B()});function St(){te=m("papersList"),we=m("fileInput"),ft=m("urlInput"),ht=m("loadJsonSection"),bt=m("saveJsonSection"),yt=m("exportResetSection"),vt=m("papersSection")}function Go(e){return new Promise((t,o)=>{let n=new FileReader;n.onload=s=>{try{let i=JSON.parse(s.target.result);t(i)}catch{o(new Error("Invalid JSON file"))}},n.onerror=()=>o(new Error("Error reading file")),n.readAsText(e)})}async function Do(e){try{let t=await fetch(e);if(!t.ok)throw new Error(`Failed to load: ${t.status}`);return await t.json()}catch(t){throw new Error(`Error loading from URL: ${t.message}`)}}async function Ao(){try{let e=await fetch("papers.json");if(!e.ok)throw new Error("papers.json not found");return await e.json()}catch(e){throw new Error("Error loading default papers: "+e.message)}}async function F(e){Fe(),U(),te&&(te.innerHTML='<p class="loading">Loading papers...</p>');try{let t;switch(e){case"file":if(!we||!we.files[0])throw new Error("Please select a file");S("Loading papers from file..."),t=await Go(we.files[0]);break;case"url":if(!ft)throw new Error("URL input not found");let i=ft.value.trim();if(!i)throw new Error("Please enter a URL");S("Loading papers from URL..."),t=await Do(i);break;case"default":t=await Ao();break;default:throw new Error("Invalid input method")}let{processPapers:o}=await Promise.resolve().then(()=>(v(),y)),n=await o(t),{renderPapers:s}=await Promise.resolve().then(()=>(v(),y));s(n),ht&&(ht.style.display="none"),bt&&(bt.style.display="block"),yt&&(yt.style.display="block"),vt&&(vt.style.display="block"),S(`Loaded ${n.length} papers successfully`),setTimeout(U,3e3)}catch(t){f(t.message),te&&(te.innerHTML="")}}var te,we,ft,ht,bt,yt,vt,xe=x(()=>{C();B()});function xt(){wt=m("urlInput")}function N(e){console.log("updateInputOptionUI: selectedValue =",e),document.querySelectorAll(".input-section__option").forEach(o=>{o.classList.remove("input-section__option--active");let n=o.querySelector(".input-section__content");n&&(n.style.display="none")});let t=document.querySelector(`.input-section__option[data-input="${e}"]`);if(console.log("updateInputOptionUI: selectedOption =",t),t){t.classList.add("input-section__option--active");let o=t.querySelector(".input-section__content");console.log("updateInputOptionUI: selectedContent =",o),o&&(o.style.display="block"),e==="gist"&&E()&&(Promise.resolve().then(()=>(ne(),oe)).then(({loadGistOptionsForLoadSelector:n})=>{n()}),Promise.resolve().then(()=>(H(),Ee)).then(({updateGistVisibility:n})=>{n()}))}}function Et(){let e=document.querySelector('input[name="inputMethod"]:checked');if(console.log("initInputOptions: selectedRadio =",e?.id),e)N(e.value);else{let t=document.getElementById("inputMethodUrl");t&&(t.checked=!0,N("url"))}En()}function En(){let t=new URLSearchParams(window.location.search).get("inputURL");if(t){console.log("[URL Parameter] Found inputURL:",t),wt&&(wt.value=t);let o=document.getElementById("inputMethodUrl");o&&(o.checked=!0,N("url")),setTimeout(()=>{F("url")},100),window.history.replaceState({},document.title,window.location.pathname)}}var wt,Bt=x(()=>{H();xe();B()});function J(e){console.log("updateSaveOptionUI: selectedValue =",e),document.querySelectorAll(".save-section__option").forEach(o=>{o.classList.remove("save-section__option--active");let n=o.querySelector(".save-section__option-content");n&&(n.style.display="none")});let t=document.querySelector(`.save-section__option[data-save="${e}"]`);if(console.log("updateSaveOptionUI: selectedOption =",t),t){t.classList.add("save-section__option--active");let o=t.querySelector(".save-section__option-content");console.log("updateSaveOptionUI: selectedContent =",o),o&&(o.style.display="block"),e==="gist"&&E()&&(Promise.resolve().then(()=>(ne(),oe)).then(({loadGistOptionsForSaveSelector:n})=>{n()}),Promise.resolve().then(()=>(H(),Ee)).then(({updateSaveGistVisibility:n})=>{n()}))}}function Be(){let e=document.querySelector('input[name="saveMethod"]:checked');if(console.log("initSaveOptions: selectedRadio =",e?.id),e)J(e.value);else{let t=document.getElementById("saveMethodFile");t&&(t.checked=!0,J("file"))}}var _e=x(()=>{H()});var It={};j(It,{closeTagDialog:()=>q,hasUnsavedChanges:()=>Ie,initTagEditorDOM:()=>Te,openTagDialog:()=>Le,toggleTag:()=>Po,updateExportButtonStates:()=>se});function Te(){_t=m("exportBibtexTaggedBtn")}function se(){_t&&(_t.disabled=r.selectedTags.size===0)}function Po(e){let t=[...r.selectedTags],o=t.indexOf(e);o>-1?t.splice(o,1):t.push(e),b.setSelectedTags(t),Promise.resolve().then(()=>(v(),y)).then(({applyTagFilter:n})=>{n(),se()})}function Ie(){let e=r.papersData[r.currentEditingKey];if(!e)return!1;let t=e._tags||[],o=[...r.tentativeTags];if(t.length!==o.length)return!0;for(let n=0;n<t.length;n++)if(t[n]!==o[n])return!0;return!1}function Le(e){if(console.log("openTagDialog called with key:",e),r.currentEditingKey!==null&&r.currentEditingKey!==e){if(Ie()&&!confirm("You have unsaved changes. Discard them?"))return;q()}b.set({currentEditingKey:e});let t=r.papersData[e];if(!t){console.error("Paper not found for key:",e);return}b.set({tentativeTags:[],tentativeTagsRemoved:[]}),(t._tags||[]).forEach(i=>{let l=typeof i=="object"?JSON.stringify(i):String(i);r.tentativeTags.push(l)});let n=document.querySelector(`.paper[data-key="${e}"]`);if(n||(n=document.querySelector(`.paper-card[data-key="${e}"]`)),!n){console.error("Card not found for key:",e);return}let s=n.querySelector(".tags");if(s||(s=n.querySelector(".tags-container")),s||(s=n.querySelector('[class*="tags"]')),!s){console.error("tags not found for key:",e);return}s.classList.add("tags--editing"),s.dataset.originalContent=s.innerHTML,Tt(s)}function Tt(e){console.log("renderInlineTagEditor called");let t="";r.tentativeTags.length===0&&r.tentativeTagsRemoved.length===0?t='<p class="tag-editor__empty">No tags yet. Add your first tag above!</p>':(r.tentativeTags.forEach(s=>{t+=`<button type="button" class="tag-editor__item" data-tag="${s}" aria-label="Remove tag: ${s}">${s} <span class="tag-editor__remove">\xD7</span></button>`}),r.tentativeTagsRemoved.forEach(s=>{t+=`<button type="button" class="tag-editor__item tag-editor__item--removed" data-tag="${s}" aria-label="Restore tag: ${s}">${s} <span class="tag-editor__restore">+</span></button>`}));let o=`
        <div class="tag-editor">
            <div class="tag-editor__add">
                <input type="text" class="tag-editor__input" placeholder="Add new tag..." aria-label="New tag name">
                <button type="button" class="tag-editor__add-btn">Add</button>
            </div>
            <div class="tag-editor__list" role="list" aria-label="Tags for this paper">
                ${t}
            </div>
            <div class="tag-editor__buttons">
                <button type="button" class="tag-editor__cancel">Cancel</button>
                <button type="button" class="tag-editor__save">Save Tag Changes</button>
            </div>
        </div>
    `;e.innerHTML=o;let n=e.querySelector(".tag-editor__input");n&&n.focus(),Bn(e)}function Bn(e){console.log("setupInlineEditorListeners called");let t=e.querySelector(".tag-editor__input"),o=e.querySelector(".tag-editor__add-btn"),n=e.querySelector(".tag-editor__cancel"),s=e.querySelector(".tag-editor__save");console.log("Elements found:",{input:t,addBtn:o,cancelBtn:n,saveBtn:s}),o?o.addEventListener("click",i=>{i.stopPropagation(),Co(e)}):console.error("tag-editor__add-btn not found!"),t&&t.addEventListener("keydown",i=>{i.key==="Enter"&&(i.preventDefault(),Co(e))}),n&&n.addEventListener("click",()=>{Ie()?confirm("You have unsaved changes. Discard them?")&&(q(),Promise.resolve().then(()=>(v(),y)).then(({applyTagFilter:i})=>{i()})):(q(),Promise.resolve().then(()=>(v(),y)).then(({applyTagFilter:i})=>{i()}))}),s&&s.addEventListener("click",_n),e.querySelectorAll(".tag-editor__item").forEach(i=>{i.addEventListener("click",l=>{l.stopPropagation();let a=i.dataset.tag;if(i.classList.contains("tag-editor__item--removed")){let p=r.tentativeTagsRemoved.indexOf(a);p>-1&&(r.tentativeTagsRemoved.splice(p,1),r.tentativeTags.push(a))}else{let p=r.tentativeTags.indexOf(a);p>-1&&(r.tentativeTags.splice(p,1),r.tentativeTagsRemoved.push(a))}Tt(e)})})}function Co(e){let t=e.querySelector(".tag-editor__input");if(!t)return;let o=t.value.trim();if(!o)return;if(r.tentativeTags.includes(o)||r.tentativeTagsRemoved.includes(o)){f("Tag already exists");return}r.tentativeTags.push(o),t.value="",Tt(e);let n=e.querySelector(".tag-editor__input");n&&n.focus()}function q({restoreContent:e=!0}={}){if(r.currentEditingKey===null)return;let t=document.querySelector(`.paper[data-key="${r.currentEditingKey}"]`);if(t||(t=document.querySelector(`.paper-card[data-key="${r.currentEditingKey}"]`)),t){let o=t.querySelector(".tags-container");o&&(o.classList.remove("editing"),e&&o.dataset.originalContent?(o.innerHTML=o.dataset.originalContent,delete o.dataset.originalContent):e||delete o.dataset.originalContent)}b.set({currentEditingKey:null,tentativeTags:[],tentativeTagsRemoved:[]})}function _n(){if(!r.currentEditingKey)return;let e=r.papersData[r.currentEditingKey],t=[...r.tentativeTags],o=e._tags||[],n=o.filter(l=>!t.includes(l)),s=t.filter(l=>!o.includes(l)),i=`Save tag changes for "${e.title||r.currentEditingKey}"?

`;if(s.length>0&&(i+=`Adding: ${s.join(", ")}
`),n.length>0&&(i+=`Removing: ${n.join(", ")}
`),s.length===0&&n.length===0&&(i+="No changes to tags."),i+=`

This action cannot be undone.`,confirm(i)){e._tags=t;let l=r.processedPapersData.find(a=>a.key===r.currentEditingKey);l&&(l.paper=r.papersData[r.currentEditingKey]),Promise.resolve().then(()=>(v(),y)).then(({applyTagFilter:a})=>{a()}),S("Tags updated successfully")}q({restoreContent:!1})}var _t,ie=x(()=>{T();C();B()});var jo={};j(jo,{saveComment:()=>$o});function $o(e,t){if(!r.papersData[e])return;let o=r.papersData[e];if((o._comments||"")!==t){o._comments=t;let s=r.processedPapersData.find(i=>i.key===e);s&&(s.paper=r.papersData[e]),console.log(`Comment saved for "${e}"`)}}var Lt=x(()=>{T()});function Gt(){_=m("onboardingModal"),ae=m("onboardingBackBtn"),le=m("onboardingNextBtn"),ce=m("onboardingCompleteBtn"),Ot=document.querySelectorAll(".onboarding__step"),de=document.querySelectorAll(".onboarding__dot")}function Ho(e,t,o){let n=new Date;n.setTime(n.getTime()+o*24*60*60*1e3),document.cookie=`${e}=${t};expires=${n.toUTCString()};path=/;SameSite=Lax`}function Ro(e){let t=`${e}=`,o=document.cookie.split(";");for(let n=0;n<o.length;n++){let s=o[n];for(;s.charAt(0)===" ";)s=s.substring(1,s.length);if(s.indexOf(t)===0)return s.substring(t.length,s.length)}return null}function Mo(){return Ro("argonaut_onboarding_complete")==="true"}function Uo(){Ho("argonaut_onboarding_complete","true",365)}function Dt(){k=0,pe(),_&&(_.classList.add("onboarding--active"),_.setAttribute("aria-hidden","false"),document.body.style.overflow="hidden")}function re(){_&&(_.classList.remove("onboarding--active"),_.setAttribute("aria-hidden","true"),document.body.style.overflow="")}function pe(){_&&(Ot&&Ot.forEach((e,t)=>{e.classList.toggle("onboarding__step--active",t===k)}),de&&de.forEach((e,t)=>{let o=t===k;e.classList.toggle("onboarding__dot--active",o),e.setAttribute("aria-selected",o.toString()),e.setAttribute("tabindex",o?"0":"-1")}),ae&&(ae.style.visibility=k===0?"hidden":"visible"),le&&(le.style.display=k===kt-1?"none":"block"),ce&&(ce.style.display=k===kt-1?"block":"none"),k===0&&_.focus())}function Fo(){k<kt-1&&(k++,pe())}function No(){k>0&&(k--,pe())}function Jo(e){k=e,pe()}function qo(){Uo(),re()}function At(){Mo()||setTimeout(()=>{Dt()},500)}function Ct(e,t){e&&e.addEventListener("click",()=>re()),le&&le.addEventListener("click",Fo),ae&&ae.addEventListener("click",No),ce&&ce.addEventListener("click",qo),t&&t.addEventListener("click",Dt),de&&de.forEach(o=>{o.addEventListener("click",()=>{Jo(parseInt(o.dataset.step))})}),document.addEventListener("keydown",o=>{o.key==="Escape"&&_&&_.classList.contains("onboarding--active")&&re()}),_&&_.addEventListener("click",o=>{o.target===_&&re()})}var k,kt,_,ae,le,ce,Ot,de,Pt=x(()=>{B();k=0,kt=6});var u={};j(u,{clearCurrentData:()=>Lo,closeTagDialog:()=>q,completeOnboarding:()=>qo,escapeHtml:()=>yn,exportBibTeX:()=>ut,exportBibTeXTagged:()=>gt,exportJSON:()=>pt,exportJSONLight:()=>xn,getCookie:()=>Ro,getMimeTypeDescription:()=>ko,getMimeTypeExtensions:()=>Oo,getStoredTheme:()=>bo,getSystemPreference:()=>ho,goToStep:()=>Jo,hasCompletedOnboarding:()=>Mo,hasUnsavedChanges:()=>Ie,hideError:()=>Fe,hideOnboarding:()=>re,hideStatus:()=>U,initDOM:()=>Xt,initEventListeners:()=>Vt,initExportDOM:()=>dt,initInputOptions:()=>Et,initInputOptionsDOM:()=>xt,initLoadDOM:()=>St,initNotificationsDOM:()=>Ue,initOnboarding:()=>At,initOnboardingDOM:()=>Gt,initOnboardingListeners:()=>Ct,initSaveOptions:()=>Be,initStorageDOM:()=>it,initTagEditorDOM:()=>Te,initTheme:()=>He,initThemeDOM:()=>$e,initThemeListener:()=>Re,loadDefault:()=>Ao,loadFromFile:()=>Go,loadFromStorage:()=>at,loadFromUrl:()=>Do,loadPapers:()=>F,markOnboardingComplete:()=>Uo,nextStep:()=>Fo,openTagDialog:()=>Le,prevStep:()=>No,saveComment:()=>$o,saveFileWithPicker:()=>ee,saveToStorage:()=>rt,setCookie:()=>Ho,setTheme:()=>be,showError:()=>f,showOnboarding:()=>Dt,showStatus:()=>S,toggleTag:()=>Po,updateExportButtonStates:()=>se,updateInputOptionUI:()=>N,updateOnboardingUI:()=>pe,updateSaveOptionUI:()=>J,updateThemeIcons:()=>je});function Xt(){Ue(),$e(),it(),dt(),St(),xt(),Te(),Gt();let e=A("loadJsonSection","saveJsonSection","papersSection","exportResetSection","papersList","fileInput","urlInput","loadUrlBtn","loadFromStorageBtn","loadNewBtn","saveToStorageBtn","exportJsonBtn","exportBibtexAllBtn","exportBibtexTaggedBtn","jsonFormatSelector","closeOnboardingBtn","showOnboardingBtn");$t=e.loadJsonSection,jt=e.saveJsonSection,Ht=e.papersSection,Rt=e.exportResetSection,R=e.papersList,K=e.fileInput,Mt=e.urlInput,Ut=e.loadUrlBtn,Ft=e.loadFromStorageBtn,Nt=e.loadNewBtn,Jt=e.saveToStorageBtn,qt=e.exportJsonBtn,Kt=e.exportBibtexAllBtn,zt=e.exportBibtexTaggedBtn,Tn=e.jsonFormatSelector,Ko=e.closeOnboardingBtn,zo=e.showOnboardingBtn,se(),console.log("[UI] DOM elements initialized")}function Vt(){console.log("[UI] Initializing event listeners"),Re(),document.querySelectorAll('input[name="inputMethod"]').forEach(e=>{e.addEventListener("change",t=>{N(t.target.value)})}),document.querySelectorAll('input[name="saveMethod"]').forEach(e=>{e.addEventListener("change",()=>J(e.value))}),K&&K.addEventListener("change",()=>{K.files[0]&&F("file")}),Ut&&Ut.addEventListener("click",()=>F("url")),Ft&&Ft.addEventListener("click",at),Nt&&Nt.addEventListener("click",()=>{confirm(`Are you sure you want to reset all papers?

This will clear:
\u2022 All papers
\u2022 All comments
\u2022 All tags
\u2022 Any unsaved changes

This action cannot be undone.`)&&(b.setSelectedTags([]),b.set({papersData:{},processedPapersData:[]}),Ht&&(Ht.style.display="none"),jt&&(jt.style.display="none"),Rt&&(Rt.style.display="none"),$t&&($t.style.display="block"),R&&(R.innerHTML=""),K&&(K.value=""),Mt&&(Mt.value="https://gist.githubusercontent.com/srtee/04ee671f6f27d64de800f00eb9280a21/raw/papers.json"),U())}),Jt&&Jt.addEventListener("click",rt),qt&&(console.log("[UI] Export JSON button found, adding click handler"),qt.addEventListener("click",()=>{console.log("[UI] Export JSON button clicked"),pt()})),Kt&&Kt.addEventListener("click",ut),zt&&zt.addEventListener("click",gt),Ct(Ko,zo),R&&R.addEventListener("click",e=>{let t=e.target.closest(".tag-edit-btn");if(t){e.stopPropagation();let o=t.dataset.key;console.log("Edit button clicked, key:",o),Le(o)}}),document.addEventListener("keydown",async e=>{if(e.key==="Escape"&&r.currentEditingKey!==null){let{hasUnsavedChanges:t,closeTagDialog:o}=await Promise.resolve().then(()=>(ie(),It));t()?confirm("You have unsaved changes. Discard them?")&&(o(),Promise.resolve().then(()=>(v(),y)).then(({applyTagFilter:n})=>{n()})):(o(),Promise.resolve().then(()=>(v(),y)).then(({applyTagFilter:n})=>{n()}))}}),document.addEventListener("click",e=>{if(r.currentEditingKey!==null){let t=document.querySelector(".tag-editor");t&&!t.contains(e.target)&&Promise.resolve().then(()=>(ie(),It)).then(({hasUnsavedChanges:o,closeTagDialog:n})=>{o()?confirm("You have unsaved changes. Discard them?")&&(n(),Promise.resolve().then(()=>(v(),y)).then(({applyTagFilter:s})=>{s()})):(n(),Promise.resolve().then(()=>(v(),y)).then(({applyTagFilter:s})=>{s()}))})}}),R&&R.addEventListener("blur",e=>{if(e.target.classList.contains("comments")){let t=e.target.dataset.key,o=e.target.value;Promise.resolve().then(()=>(Lt(),jo)).then(({saveComment:n})=>{n(t,o)})}},!0),console.log("[UI] Event listeners initialized")}var $t,jt,Ht,Rt,R,K,Mt,Ut,Ft,Nt,Jt,qt,Kt,zt,Tn,Ko,zo,g=x(()=>{T();B();Me();C();lt();mt();xe();Bt();_e();ie();Lt();Pt();_e();Me();C();lt();mt();xe();Bt();_e();ie();Pt();C()});var oe={};j(oe,{createGist:()=>Vo,getGist:()=>Xo,initDOM:()=>Yt,listGists:()=>Zt,loadFromGistCollection:()=>Zo,loadGistOptionsForLoadSelector:()=>kn,loadGistOptionsForSaveSelector:()=>Yo,saveToGistCollection:()=>Qo,updateGist:()=>Wo});function Yt(){let e=A("loadGistSelector","saveGistSelector","loadFromGistCollectionBtn","saveToGistOptionBtn","gistConnectedContent","saveGistConnectedContent","jsonFormatSelector");P=e.loadGistSelector,$=e.saveGistSelector,z=e.loadFromGistCollectionBtn,M=e.saveToGistOptionBtn,In=e.gistConnectedContent,Ln=e.saveGistConnectedContent,Wt=e.jsonFormatSelector,z&&z.addEventListener("click",Zo),M&&M.addEventListener("click",Qo),console.log("[GitHub] DOM elements initialized")}async function Zt(){console.log("[GitHub API] Listing user gists");let e=E(),t={};e&&(t.Authorization=`Bearer ${e}`);let o=await fetch(`${O}/api/github/gists`,{headers:t,credentials:"include"});if(!o.ok){let s=await o.json();throw console.error("[GitHub API] Failed to list gists:",s),new Error(s.error||"Failed to fetch gists")}let n=await o.json();return console.log("[GitHub API] Listed gists:",n.length),n}async function Xo(e){console.log("[GitHub API] Getting gist:",e);let t=E(),o={};t&&(o.Authorization=`Bearer ${t}`);let n=await fetch(`${O}/api/github/gists/${e}`,{headers:o,credentials:"include"});if(!n.ok){let i=await n.json();throw console.error("[GitHub API] Failed to get gist:",e,i),new Error(i.error||"Failed to fetch gist")}let s=await n.json();return console.log("[GitHub API] Got gist:",e),s}async function Vo(e,t="Argonaut Papers"){console.log("[GitHub API] Creating new gist with description:",t);let o=E(),n={"Content-Type":"application/json"};o&&(n.Authorization=`Bearer ${o}`);let s=await fetch(`${O}/api/github/gists`,{method:"POST",headers:n,body:JSON.stringify({description:t,public:!1,files:e}),credentials:"include"});if(!s.ok){let l=await s.json();throw console.error("[GitHub API] Failed to create gist:",l),new Error(l.error||"Failed to create gist")}let i=await s.json();return console.log("[GitHub API] Created gist:",i.id),i}async function Wo(e,t,o="Argonaut Papers"){console.log("[GitHub API] Updating gist:",e);let n=E(),s={"Content-Type":"application/json"};n&&(s.Authorization=`Bearer ${n}`);let i=await fetch(`${O}/api/github/gists/${e}`,{method:"PATCH",headers:s,body:JSON.stringify({description:o,files:t}),credentials:"include"});if(!i.ok){let a=await i.json();throw console.error("[GitHub API] Failed to update gist:",e,a),new Error(a.error||"Failed to update gist")}let l=await i.json();return console.log("[GitHub API] Updated gist:",e),l}async function kn(){console.log("[GitHub Gist] Loading gist options for load selector");try{let e=await Zt();if(P){if(P.innerHTML="",e.length===0){console.log("[GitHub Gist] No gists found"),P.innerHTML='<option value="">No gists found</option>';return}e.forEach(t=>{let o=document.createElement("option");o.value=t.id;let n=t.description||Object.keys(t.files)[0]||"Unnamed gist";o.textContent=n,P.appendChild(o)}),console.log("[GitHub Gist] Loaded",e.length,"gist options for load selector")}}catch(e){console.error("[GitHub Gist] Error loading gists for load selector:",e),P&&(P.innerHTML='<option value="">Failed to load gists</option>')}}async function Yo(){console.log("[GitHub Gist] Loading gist options for save selector");try{let e=await Zt();if($){$.innerHTML="";let t=document.createElement("option");if(t.value="new",t.textContent="(new gist)",$.appendChild(t),e.length===0){console.log("[GitHub Gist] No existing gists found");return}e.forEach(o=>{let n=document.createElement("option");n.value=o.id;let s=o.description||Object.keys(o.files)[0]||"Unnamed gist";n.textContent=s,$.appendChild(n)}),console.log("[GitHub Gist] Loaded",e.length,"gist options for save selector")}}catch(e){console.error("[GitHub Gist] Error loading gists for save selector:",e),$&&($.innerHTML='<option value="">Failed to load gists</option>')}}async function Zo(){console.log("[GitHub Gist] Loading from gist collection");let e=P.value;if(!e||e==="Loading gists..."||e==="No gists found"||e==="Failed to load gists"){console.log("[GitHub Gist] Invalid gist selected");let{showError:n}=await Promise.resolve().then(()=>(g(),u));n("Please select a gist to load from");return}console.log("[GitHub Gist] Loading from gist:",e),z.classList.add("loading");let{showStatus:t,hideStatus:o}=await Promise.resolve().then(()=>(g(),u));t("Loading from Gist...");try{let n=await Xo(e),s=Object.values(n.files).find(G=>G.filename==="papers.json");if(!s){console.log("[GitHub Gist] No papers.json found in gist");let{showError:G}=await Promise.resolve().then(()=>(g(),u));G("Selected gist does not contain a papers.json file");let{hideStatus:w}=await Promise.resolve().then(()=>(g(),u));w(),z.classList.remove("loading");return}let i=JSON.parse(s.content);console.log("[GitHub Gist] Loaded",Object.keys(i).length,"papers from gist");let{clearCurrentData:l}=await Promise.resolve().then(()=>(g(),u));l();let{store:a}=await Promise.resolve().then(()=>(T(),Ge));a.set({papersData:i});let{processPapers:c}=await Promise.resolve().then(()=>(v(),y)),p=await c(i),{renderPapers:d}=await Promise.resolve().then(()=>(v(),y));d(p),loadJsonSection.style.display="none",saveJsonSection.style.display="block",exportResetSection.style.display="block",papersSection.style.display="block",t(`Loaded ${Object.keys(i).length} papers from Gist`),setTimeout(o,3e3),console.log("[GitHub Gist] Successfully loaded papers from gist:",e)}catch(n){console.error("[GitHub Gist] Error loading from gist:",n);let{showError:s}=await Promise.resolve().then(()=>(g(),u));s("Error loading from Gist: "+n.message);let{hideStatus:i}=await Promise.resolve().then(()=>(g(),u));i()}finally{z.classList.remove("loading")}}async function Qo(){console.log("[GitHub Gist] Saving papers to gist from Save JSON Collection");let e=$.value;if(!e||e==="Loading gists..."||e==="No gists found"||e==="Failed to load gists"){console.log("[GitHub Gist] Invalid gist selected");let{showError:o}=await Promise.resolve().then(()=>(g(),u));o("Please select a gist to save to");return}M.classList.add("loading");let{showStatus:t}=await Promise.resolve().then(()=>(g(),u));t("Saving to Gist...");try{let{state:o}=await Promise.resolve().then(()=>(T(),Ge));if(!o.papersData||Object.keys(o.papersData).length===0){console.log("[GitHub Gist] No papers to save");let{showError:a}=await Promise.resolve().then(()=>(g(),u));a("No papers to save");let{hideStatus:c}=await Promise.resolve().then(()=>(g(),u));c(),M.classList.remove("loading");return}let n=Wt?Wt.value:"full",s=o.papersData;if(n==="light"){s={};for(let[a,c]of Object.entries(o.papersData))s[a]={_doi:c._doi,_comments:c._comments||[],_tags:c._tags||[],_alsoread:c._alsoread||[]}}let l={"papers.json":{content:JSON.stringify(s,null,2)}};if(console.log("[GitHub Gist] Saving",Object.keys(s).length,"papers"),e==="new"){console.log("[GitHub Gist] Creating new gist");let a=prompt("Enter a name for your new gist:","Argonaut Papers");if(a===null){let{hideStatus:G}=await Promise.resolve().then(()=>(g(),u));G(),M.classList.remove("loading");return}let c=a.trim()||"Argonaut Papers",p=await Vo(l,c);console.log("[GitHub Gist] Created gist:",p.id);let{showStatus:d}=await Promise.resolve().then(()=>(g(),u));d("Created new Gist successfully"),await Yo()}else{console.log("[GitHub Gist] Updating existing gist:",e),await Wo(e,l),console.log("[GitHub Gist] Updated gist:",e);let{showStatus:a}=await Promise.resolve().then(()=>(g(),u));a("Saved to Gist successfully")}setTimeout(async()=>{let{hideStatus:a}=await Promise.resolve().then(()=>(g(),u));a()},3e3)}catch(o){console.error("[GitHub Gist] Error saving to gist:",o);let{showError:n}=await Promise.resolve().then(()=>(g(),u));n("Error saving to Gist: "+o.message);let{hideStatus:s}=await Promise.resolve().then(()=>(g(),u));s()}finally{M.classList.remove("loading")}}var P,$,z,M,In,Ln,Wt,ne=x(()=>{H();T();B()});var Ee={};j(Ee,{checkSession:()=>nn,clearSessionId:()=>eo,getSessionId:()=>E,initDOM:()=>so,initEventListeners:()=>lo,initGitHubAuth:()=>ao,initiateLogin:()=>sn,loadGitHubAuth:()=>ln,logout:()=>rn,restorePapersState:()=>cn,setSessionId:()=>on,updateGistVisibility:()=>ro,updateGitHubUI:()=>an,updateSaveGistVisibility:()=>io});function so(){let e=A("githubSection","githubNotLoggedIn","githubLoggedIn","githubConnectBtn","githubLogoutBtn","githubUserAvatar","githubUserName","gistConnectedContent","saveGistConnectedContent","loadJsonSection","saveJsonSection","exportResetSection","papersSection");On=e.githubSection,ke=e.githubNotLoggedIn,Oe=e.githubLoggedIn,X=e.githubConnectBtn,V=e.githubLogoutBtn,Qt=e.githubUserAvatar,en=e.githubUserName,ue=e.gistConnectedContent,ge=e.saveGistConnectedContent,tn=e.loadJsonSection,to=e.saveJsonSection,oo=e.exportResetSection,no=e.papersSection,console.log("[Auth] DOM elements initialized")}function E(){return localStorage.getItem("github_session_id")}function on(e){localStorage.setItem("github_session_id",e)}function eo(){localStorage.removeItem("github_session_id")}async function nn(){console.log("[GitHub Auth] Checking session at:",`${O}/session`);let e=E();console.log("[GitHub Auth] Session ID from storage:",e?e.substring(0,10)+"...":"null");try{let t={};e&&(t.Authorization=`Bearer ${e}`);let o=await fetch(`${O}/session`,{headers:t,credentials:"include"});if(console.log("[GitHub Auth] Request URL:",o.url),console.log("[GitHub Auth] Session response status:",o.status),!o.ok)return console.log("[GitHub Auth] Session response not OK"),{authenticated:!1};let n=await o.json();return console.log("[GitHub Auth] Session data:",n),n}catch(t){return console.error("[GitHub Auth] Error checking session:",t),{authenticated:!1}}}async function sn(){console.log("[GitHub Auth] Initiating login, redirecting to GitHub OAuth");let e={hasPapers:Object.keys(r.papersData).length>0,saveJsonVisible:to?.style.display==="block",exportResetVisible:oo?.style.display==="block",papersVisible:no?.style.display==="block",papersData:r.papersData,processedPapersData:r.processedPapersData,selectedTags:Array.from(r.selectedTags)};sessionStorage.setItem("argonaut_oauth_state",JSON.stringify(e)),window.location.href=`${O}/login`}async function rn(){console.log("[GitHub Auth] Initiating logout");let e=E();try{let t={};e&&(t.Authorization=`Bearer ${e}`);let o=await fetch(`${O}/logout`,{method:"POST",headers:t,credentials:"include"});console.log("[GitHub Auth] Logout response status:",o.status),eo(),localStorage.removeItem("github_selected_gist"),console.log("[GitHub Auth] User logged out successfully")}catch(t){console.error("[GitHub Auth] Error logging out:",t),eo(),localStorage.removeItem("github_selected_gist")}ke&&(ke.style.display="block"),Oe&&(Oe.style.display="none"),X&&(X.style.display="block"),V&&(V.style.display="none"),ro(),io(),console.log("[GitHub Auth] UI updated to logged-out state")}function an(e){console.log("[GitHub Auth] updateGitHubUI called with user:",e),ke.style.display="none",Oe.style.display="flex",X.style.display="none",V.style.display="inline-block",Qt.src=e.avatar_url,Qt.alt=e.login,en.textContent=e.login,ro(),io(),console.log("[GitHub Auth] UI updated")}function io(){E()?ge&&(ge.style.display="flex"):ge&&(ge.style.display="none")}function ro(){E()?ue&&(ue.style.display="flex"):ue&&(ue.style.display="none")}async function ln(){console.log("[GitHub Auth] loadGitHubAuth called");let e=await nn();if(console.log("[GitHub Auth] Session result:",e),e.authenticated&&e.user){console.log("[GitHub Auth] User authenticated, updating UI"),an(e.user);let{loadGistOptionsForLoadSelector:t}=await Promise.resolve().then(()=>(ne(),oe));await t()}else console.log("[GitHub Auth] User not authenticated or no user data")}async function ao(){console.log("[GitHub Auth] initGitHubAuth called");let e=new URLSearchParams(window.location.search);console.log("[GitHub Auth] URL params:",Object.fromEntries(e.entries()));let t=e.get("session_id"),o=e.get("auth");if(console.log("[GitHub Auth] Session ID from URL:",t?t.substring(0,10)+"...":"null"),console.log("[GitHub Auth] Auth status from URL:",o),t&&o==="success"){console.log("[GitHub Auth] OAuth callback received, storing session ID"),on(t),console.log("[GitHub Auth] Session ID stored:",E()?E().substring(0,10)+"...":"null"),window.history.replaceState({},document.title,window.location.pathname);let{showStatus:n}=await Promise.resolve().then(()=>(g(),u));n("Successfully connected to GitHub");let{hideStatus:s}=await Promise.resolve().then(()=>(g(),u));setTimeout(s,3e3),await cn()}else if(r.papersData&&Object.keys(r.papersData).length>0){let{displayPapers:n}=await Promise.resolve().then(()=>(v(),y));await n()}await ln()}async function cn(){let e=sessionStorage.getItem("argonaut_oauth_state");if(e)try{let t=JSON.parse(e);if(t.hasPapers){t.papersData&&b.set({papersData:t.papersData}),t.processedPapersData&&b.set({processedPapersData:t.processedPapersData}),t.selectedTags&&b.setSelectedTags(t.selectedTags),t.saveJsonVisible&&(to.style.display="block"),t.exportResetVisible&&(oo.style.display="block"),t.papersVisible&&(no.style.display="block"),tn.style.display="none";let{displayPapers:o}=await Promise.resolve().then(()=>(v(),y));await o()}sessionStorage.removeItem("argonaut_oauth_state")}catch(t){console.error("[GitHub Auth] Error restoring state:",t)}else if(r.papersData&&Object.keys(r.papersData).length>0){let{displayPapers:t}=await Promise.resolve().then(()=>(v(),y));await t()}}function lo(){console.log("[Auth] Initializing event listeners"),X&&X.addEventListener("click",sn),V&&V.addEventListener("click",rn),console.log("[Auth] Event listeners initialized")}var On,ke,Oe,X,V,Qt,en,ue,ge,tn,to,oo,no,H=x(()=>{T();T();B()});T();H();ne();v();g();B();document.addEventListener("DOMContentLoaded",()=>{fo(),Xt(),so(),Yt(),Ye(),Vt(),ot(),lo(),He(),ao(),Et(),Be(),At()});
//# sourceMappingURL=main.TJDLTFKY.js.map
