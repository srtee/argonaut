// Built with esbuild

var Wn=Object.defineProperty;var y=(e,t)=>()=>(e&&(t=e(e=0)),t);var $=(e,t)=>{for(var o in t)Wn(e,o,{get:t[o],enumerable:!0})};var nt={};$(nt,{WORKER_BASE_URL:()=>F,state:()=>a,store:()=>S});var Fo,F,Yn,_e,Ho,No,D,S,a,C=y(()=>{Fo="appState",F="https://argonaut-github-proxy.shernren.workers.dev",Yn={papersData:{},selectedTags:new Set,processedPapersData:[],currentEditingKey:null,tentativeTags:[],tentativeTagsRemoved:[]},_e=new Set,Ho=e=>{try{let t={...e,selectedTags:Array.from(e.selectedTags)};sessionStorage.setItem(Fo,JSON.stringify(t))}catch(t){console.warn("Failed to persist state:",t)}},No=()=>{try{let e=sessionStorage.getItem(Fo);return e?JSON.parse(e):{}}catch(e){return console.warn("Failed to load state from storage:",e),{}}},D={...Yn,...No(),selectedTags:new Set(No().selectedTags||[])},S={get:()=>({...D}),set:e=>{D={...D,...e},Ho(D),_e.forEach(t=>t(D))},setSelectedTags:e=>{D={...D,selectedTags:new Set(e)},Ho(D),_e.forEach(t=>t(D))},subscribe:e=>(_e.add(e),e(D),()=>_e.delete(e))},a=new Proxy({},{get(e,t){return D[t]},set(e,t,o){return console.warn(`Direct mutation of state.${t} is discouraged. Use store.set() instead.`),D[t]=o,!0}})});function Be(e,t){Jo.set(e,t),console.log(`[DOM Registry] Registered ${Object.keys(t).length} elements for module: ${e}`)}function h(e){return ke.get(e)||null}function M(...e){let t={};for(let o of e)t[o]=ke.get(o)||null;return t}function qo(){console.log("[DOM Registry] Initializing all DOM elements..."),Qn(),Zn(),es(),ts(),os(),console.log("[DOM Registry] Initialization complete")}function Qn(){Be("ui",{loadJsonSection:document.getElementById("loadJsonSection"),saveJsonSection:document.getElementById("saveJsonSection"),papersSection:document.getElementById("papersSection"),exportResetSection:document.getElementById("exportResetSection"),papersList:document.getElementById("papersList"),fileInput:document.getElementById("fileInput"),urlInput:document.getElementById("urlInput"),loadUrlBtn:document.getElementById("loadUrlBtn"),loadFromStorageBtn:document.getElementById("loadFromStorageBtn"),loadNewBtn:document.getElementById("loadNewBtn"),saveToStorageBtn:document.getElementById("saveToStorageBtn"),exportJsonBtn:document.getElementById("exportJsonBtn"),exportBibtexAllBtn:document.getElementById("exportBibtexAllBtn"),exportBibtexTaggedBtn:document.getElementById("exportBibtexTaggedBtn"),jsonFormatSelector:document.getElementById("jsonFormatSelector"),error:document.getElementById("error"),status:document.getElementById("status"),themeToggle:document.getElementById("themeToggle"),onboardingModal:document.getElementById("onboardingModal"),closeOnboardingBtn:document.getElementById("closeOnboardingBtn"),showOnboardingBtn:document.getElementById("showOnboardingBtn"),onboardingNextBtn:document.getElementById("onboardingNextBtn"),onboardingBackBtn:document.getElementById("onboardingBackBtn"),onboardingCompleteBtn:document.getElementById("onboardingCompleteBtn")})}function Zn(){Be("auth",{githubSection:document.getElementById("githubSection"),githubNotLoggedIn:document.getElementById("githubNotLoggedIn"),githubLoggedIn:document.getElementById("githubLoggedIn"),githubConnectBtn:document.getElementById("githubConnectBtn"),githubLogoutBtn:document.getElementById("githubLogoutBtn"),githubUserAvatar:document.getElementById("githubUserAvatar"),githubUserName:document.getElementById("githubUserName"),gistConnectedContent:document.getElementById("gistConnectedContent"),saveGistConnectedContent:document.getElementById("saveGistConnectedContent")})}function es(){Be("papers",{papersList:document.getElementById("papersList"),loadJsonSection:document.getElementById("loadJsonSection"),saveJsonSection:document.getElementById("saveJsonSection"),exportResetSection:document.getElementById("exportResetSection"),papersSection:document.getElementById("papersSection"),doiInput:document.getElementById("doiInput"),doiKeyInput:document.getElementById("doiKeyInput"),addDoiBtn:document.getElementById("addDoiBtn"),status:document.getElementById("status"),exportBibtexTaggedBtn:document.getElementById("exportBibtexTaggedBtn")})}function ts(){Be("github",{loadGistSelector:document.getElementById("loadGistSelector"),saveGistSelector:document.getElementById("saveGistSelector"),loadFromGistCollectionBtn:document.getElementById("loadFromGistCollectionBtn"),saveToGistOptionBtn:document.getElementById("saveToGistOptionBtn"),gistConnectedContent:document.getElementById("gistConnectedContent"),saveGistConnectedContent:document.getElementById("saveGistConnectedContent"),jsonFormatSelector:document.getElementById("jsonFormatSelector")})}function os(){let e=0;for(let[t,o]of Jo)for(let[n,s]of Object.entries(o))s?ke.set(n,s):(console.warn(`[DOM Registry] Missing element: #${n} (module: ${t})`),e++);e>0&&console.warn(`[DOM Registry] ${e} element(s) missing from DOM`),console.log(`[DOM Registry] ${ke.size} elements registered`)}var ke,Jo,L=y(()=>{ke=new Map,Jo=new Map});function ss(e){return e.startsWith(ns)}async function st(e,t={}){console.log("[httpClient] Request:",e,"options:",JSON.stringify({...t,credentials:t.credentials||"default"}));let{body:o,...n}=t,s=ss(e),c={credentials:e.includes("api.crossref.org")?"omit":s?"include":"same-origin",mode:e.includes("api.crossref.org")?"cors":void 0,...n},i={...t.headers};c.headers=i,o instanceof FormData&&delete c.headers["Content-Type"],console.log("[httpClient] Fetching:",e,"options:",c);try{let d=await fetch(e,c);return console.log("[httpClient] Response status:",d.status,"ok:",d.ok),d}catch(d){throw console.error("[httpClient] Fetch error:",d),d}}async function R(e,t={}){let o={Accept:"application/json",...t.headers},n=await st(e,{...t,headers:o});if(!n.ok){let s=`Request failed with status ${n.status}`;try{let r=await n.json();s=r.error||r.message||s}catch{}throw new Error(s)}return n.json()}async function rt(e,t={}){let o=await st(e,{...t,headers:t.headers||{}});if(!o.ok)throw new Error(`Request failed with status ${o.status}`);return o.text()}var ns,J=y(()=>{ns="https://argonaut-github-proxy.shernren.workers.dev"});async function ne(e){try{return await rt(`${rs}/${encodeURIComponent(e)}`,{headers:{Accept:"application/x-bibtex"}})}catch(t){return console.error("[DOIClient] Error fetching BibTeX:",t),null}}var rs,Xo=y(()=>{J();rs="https://doi.org"});async function Ie(e){try{let t=await R(`${as}/DOI:${encodeURIComponent(e)}?fields=abstract`);return t.abstract?t.abstract:null}catch(t){return console.error("[SemanticScholarClient] Error fetching abstract:",t),null}}var as,Ko=y(()=>{J();as="https://api.semanticscholar.org/graph/v1/paper"});async function Le(e){try{let t=`${zo}/${encodeURIComponent(e)}`;console.log("[CrossrefClient] fetchAbstract URL:",t);let o=await R(t);return console.log("[CrossrefClient] fetchAbstract response:",o.message),o.message&&o.message.abstract?o.message.abstract:null}catch(t){return console.error("[CrossrefClient] Error fetching abstract:",t),null}}async function Te(e){console.log("[CrossrefClient] fetchPages called with doi:",e,"type:",typeof e);try{let t=`${zo}/${encodeURIComponent(e)}`;console.log("[CrossrefClient] fetchPages URL:",t);let o=await R(t);if(console.log("[CrossrefClient] fetchPages response:",o.message),o.message){if(o.message.page)return o.message.page;if(o.message["article-number"])return o.message["article-number"]}return null}catch(t){return console.error("[CrossrefClient] Error fetching pages:",t),console.error("[CrossrefClient] Error stack:",t.stack),null}}var zo,Vo=y(()=>{J();zo="https://api.crossref.org/works"});function B(){return localStorage.getItem("github_session_id")}function Ce(e){localStorage.setItem("github_session_id",e)}function Oe(){localStorage.removeItem("github_session_id")}function Wo(){let e={},t=B();return t&&(e.Authorization=`Bearer ${t}`),e}async function at(){try{let e=await fetch(`${F}/session`,{headers:Wo(),credentials:"include"});return e.ok?await e.json():{authenticated:!1}}catch(e){return console.error("[AuthClient] Error checking session:",e),{authenticated:!1}}}async function it(){window.location.href=`${F}/login`}async function ct(){let e=B();try{await fetch(`${F}/logout`,{method:"POST",headers:Wo(),credentials:"include"})}catch(t){console.error("[AuthClient] Error logging out:",t)}Oe(),localStorage.removeItem("github_selected_gist")}var lt=y(()=>{J();C()});function Ae(){let e={},t=B();return t&&(e.Authorization=`Bearer ${t}`),e}async function dt(){try{return await R(De,{headers:Ae()})}catch(e){throw console.error("[GitHubClient] Error listing gists:",e),e}}async function pt(e){try{return await R(`${De}/${e}`,{headers:Ae()})}catch(t){throw console.error("[GitHubClient] Error getting gist:",t),t}}async function ut(e,t="Argonaut Papers"){try{return await R(De,{method:"POST",headers:Ae(),body:JSON.stringify({description:t,public:!1,files:e})})}catch(o){throw console.error("[GitHubClient] Error creating gist:",o),o}}async function gt(e,t,o="Argonaut Papers"){try{return await R(`${De}/${e}`,{method:"PATCH",headers:Ae(),body:JSON.stringify({description:o,files:t})})}catch(n){throw console.error("[GitHubClient] Error updating gist:",n),n}}var De,Yo=y(()=>{J();lt();C();De=`${F}/api/github/gists`});var Ge=y(()=>{J();Xo();Ko();Vo();lt();Yo()});function ft(){se=h("error"),Pe=h("status")}function is(e){if(!e)return"";let t=document.createElement("div");return t.textContent=e,t.innerHTML}function b(e){se.textContent=e,se.classList.add("error--visible"),setTimeout(()=>{se.classList.remove("error--visible")},5e3)}function k(e){Pe.textContent=e,Pe.classList.add("status--visible")}function V(){Pe.classList.remove("status--visible")}function mt(){se.classList.remove("error--visible")}var se,Pe,U=y(()=>{L()});function Re(){try{let e=localStorage.getItem(Qo);return e?JSON.parse(e):{}}catch(e){return console.warn("[BibCache] Failed to load cache:",e),{}}}function ht(e){try{localStorage.setItem(Qo,JSON.stringify(e))}catch(t){console.warn("[BibCache] Failed to save cache:",t)}}function Zo(e){return Re()[e]||null}function en(e,t){let o=Re();o[e]={bibtex:t.bibtex||null,bibInfo:t.bibInfo||null,abstract:t.abstract||null,cachedAt:Date.now()};let n=Object.keys(o);n.length>10&&n.sort((c,i)=>(o[c].cachedAt||0)-(o[i].cachedAt||0)).slice(0,n.length-10).forEach(c=>delete o[c]),ht(o),console.log("[BibCache] Cached paper:",e)}function tn(e,t){let o=Re();o[e]&&(o[t]=o[e],delete o[e],ht(o),console.log("[BibCache] Updated key:",e,"->",t))}function on(e){let t=Re();delete t[e],ht(t),console.log("[BibCache] Removed cached paper:",e)}var Qo,nn=y(()=>{Qo="bibCache"});function xt(){yt=h("themeToggle"),bt=document.querySelector(".theme-toggle__icon--sun"),vt=document.querySelector(".theme-toggle__icon--moon")}function wt(e){bt&&(bt.style.display=e?"block":"none"),vt&&(vt.style.display=e?"none":"block")}function sn(){return window.matchMedia("(prefers-color-scheme: dark)").matches}function rn(){let e=localStorage.getItem(St);return e==="dark"?"dark":e==="light"?"light":null}function $e(e){let t=e==="dark";t?document.documentElement.setAttribute("data-theme","dark"):document.documentElement.removeAttribute("data-theme"),localStorage.setItem(St,e),wt(t)}function Et(){let e=rn();if(e)$e(e);else{let t=sn();t?document.documentElement.setAttribute("data-theme","dark"):document.documentElement.removeAttribute("data-theme"),wt(t)}}function _t(){yt&&yt.addEventListener("click",()=>{let t=document.documentElement.getAttribute("data-theme")==="dark"?"light":"dark";$e(t)}),window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",e=>{localStorage.getItem(St)||$e(e.matches?"dark":"light")})}var yt,bt,vt,St,kt=y(()=>{L();St="theme"});function Lt(){Bt=h("papersList"),It=h("jsonFormatSelector")}function an(){S.set({papersData:{},selectedTags:new Set,processedPapersData:[]}),Bt&&(Bt.innerHTML="")}function Tt(){if(!a.papersData||Object.keys(a.papersData).length===0){b("No papers to save");return}try{let e=It?It.value:"full",t=a.papersData;if(e==="light"){t={};for(let[n,s]of Object.entries(a.papersData))t[n]={_doi:s._doi,_comments:s._comments||[],_tags:s._tags||[],_alsoread:s._alsoread||[]}}let o=JSON.stringify(t);localStorage.setItem("argonautPapers",o),k("Papers saved to browser storage")}catch(e){console.error("Error saving to storage:",e),b("Error saving to storage: "+e.message)}}async function Ct(){try{let e=localStorage.getItem("argonautPapers");if(!e){b("No papers found in browser storage");return}let t=JSON.parse(e);if(!t||Object.keys(t).length===0){b("No papers found in browser storage");return}an(),S.set({papersData:t});let{displayPapers:o}=await Promise.resolve().then(()=>(E(),w));o(),k(`Loaded ${Object.keys(t).length} papers from browser storage`)}catch(e){console.error("Error loading from storage:",e),b("Error loading from storage: "+e.message)}}var Bt,It,Ot=y(()=>{C();U();L()});function At(){Dt=h("jsonFormatSelector"),re=h("status")}async function ae(e,t,o){if(console.log("[Export] saveFileWithPicker called"),console.log("[Export] showSaveFilePicker in window:","showSaveFilePicker"in window),console.log("[Export] defaultFilename:",t),"showSaveFilePicker"in window){console.log("[Export] Using File System Access API");try{console.log("[Export] Calling showSaveFilePicker...");let s=await(await window.showSaveFilePicker({suggestedName:t,types:[{description:cn(o),accept:{[o]:ln(o)}}]})).createWritable();return await s.write(e),await s.close(),!0}catch(n){if(n.name==="AbortError")return!1;throw n}}else{let n=new Blob([e],{type:o}),s=URL.createObjectURL(n),r=document.createElement("a");return r.href=s,r.download=t,r.style.display="none",document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(s),!0}}function cn(e){switch(e){case"application/json":return"JSON File";case"text/plain":case"text/x-bibtex":return"BibTeX File";default:return"File"}}function ln(e){switch(e){case"application/json":return[".json"];case"text/plain":case"text/x-bibtex":return[".bib",".txt"];default:return[".*"]}}async function Gt(){if(console.log("[Export] exportJSON called"),console.log("[Export] state.papersData:",a.papersData),console.log("[Export] showSaveFilePicker available:","showSaveFilePicker"in window),!a.papersData||Object.keys(a.papersData).length===0){b("No papers to export");return}try{let e=Dt?Dt.value:"full";console.log("[Export] format:",e);let t=a.papersData,o="papers.json";if(e==="light"){t={};for(let[r,c]of Object.entries(a.papersData))t[r]={_doi:c._doi,_comments:c._comments||[],_tags:c._tags||[],_alsoread:c._alsoread||[]};o="papers-light.json"}let n=JSON.stringify(t,null,2);await ae(n,o,"application/json")&&k("JSON exported successfully")}catch(e){console.error("Error exporting JSON:",e),b("Error exporting JSON: "+e.message)}}async function cs(){if(!a.papersData||Object.keys(a.papersData).length===0){b("No papers to export");return}try{let e={};for(let[n,s]of Object.entries(a.papersData))e[n]={_doi:s._doi,_comments:s._comments,_tags:s._tags,_alsoread:s._alsoread};let t=JSON.stringify(e,null,2);await ae(t,"papers-light.json","application/json")&&k("JSON (light) exported successfully")}catch(e){console.error("Error exporting JSON (light):",e),b("Error exporting JSON (light): "+e.message)}}async function Pt(){if(console.log("[Export] exportBibTeX called"),!a.papersData||Object.keys(a.papersData).length===0){b("No papers to export");return}try{console.log("[Export] Importing papers.js...");let{fetchBibTeX:e,fetchPagesFromCrossref:t,addPagesToBibTeX:o,parseBibTeX:n}=await Promise.resolve().then(()=>(E(),w));console.log("[Export] Imported functions:",{fetchBibTeX:e,fetchPagesFromCrossref:t,addPagesToBibTeX:o,parseBibTeX:n}),k("Fetching BibTeX entries...");let s=Object.entries(a.papersData),r="";for(let i=0;i<s.length;i++){let[d,p]=s[i];if(re&&(re.textContent=`Fetching BibTeX ${i+1} of ${s.length}: ${d}`),await new Promise(l=>setTimeout(l,0)),p._doi){let l=await e(p._doi);if(l){let x=n(l).pages;x||(x=await t(p._doi)),x&&(l=o(l,x)),r+=l+`

`}else r+=`@misc{${d.replace(/\s+/g,"")},
  title = {${d}},
  doi = {${p._doi}}
}

`}else r+=`@misc{${d.replace(/\s+/g,"")},
  title = {${d}}
}

`;i<s.length-1&&await new Promise(l=>setTimeout(l,1e3))}await ae(r,"papers.bib","text/x-bibtex")&&k(`BibTeX exported successfully (${s.length} entries)`)}catch(e){console.error("Error exporting BibTeX:",e),console.error("Error stack:",e.stack),b("Error exporting BibTeX: "+e.message)}}async function Rt(){if(console.log("[Export] exportBibTeXTagged called"),!a.papersData||Object.keys(a.papersData).length===0){b("No papers to export");return}if(a.selectedTags.size===0){b("Please select at least one tag first");return}try{let{fetchBibTeX:e,fetchPagesFromCrossref:t,addPagesToBibTeX:o,parseBibTeX:n}=await Promise.resolve().then(()=>(E(),w));k("Fetching BibTeX entries for tagged papers...");let s=Object.entries(a.papersData).filter(([i,d])=>(d._tags||[]).some(l=>a.selectedTags.has(l)));if(s.length===0){b("No papers found with the selected tags");return}let r="";for(let i=0;i<s.length;i++){let[d,p]=s[i];if(re&&(re.textContent=`Fetching BibTeX ${i+1} of ${s.length}: ${d}`),await new Promise(l=>setTimeout(l,0)),p._doi){let l=await e(p._doi);if(l){let x=n(l).pages;x||(x=await t(p._doi)),x&&(l=o(l,x)),r+=l+`

`}else r+=`@misc{${d.replace(/\s+/g,"")},
  title = {${d}},
  doi = {${p._doi}}
}

`}else r+=`@misc{${d.replace(/\s+/g,"")},
  title = {${d}}
}

`;i<s.length-1&&await new Promise(l=>setTimeout(l,1e3))}await ae(r,"papers-tagged.bib","text/x-bibtex")&&k(`BibTeX exported successfully (${s.length} entries with selected tags)`)}catch(e){console.error("Error exporting BibTeX:",e),console.error("Error stack:",e.stack),b("Error exporting BibTeX: "+e.message)}}var Dt,re,$t=y(()=>{C();U();L()});var ie={};$(ie,{createGist:()=>pn,getGist:()=>dn,initDOM:()=>Mt,listGists:()=>Ut,loadFromGistCollection:()=>fn,loadGistOptionsForLoadSelector:()=>ps,loadGistOptionsForSaveSelector:()=>gn,saveToGistCollection:()=>mn,updateGist:()=>un});function Mt(){let e=M("loadGistSelector","saveGistSelector","loadFromGistCollectionBtn","saveToGistOptionBtn","gistConnectedContent","saveGistConnectedContent","jsonFormatSelector");H=e.loadGistSelector,N=e.saveGistSelector,W=e.loadFromGistCollectionBtn,q=e.saveToGistOptionBtn,ls=e.gistConnectedContent,ds=e.saveGistConnectedContent,jt=e.jsonFormatSelector,W&&W.addEventListener("click",fn),q&&q.addEventListener("click",mn),console.log("[GitHub] DOM elements initialized")}async function Ut(){return dt()}async function dn(e){return pt(e)}async function pn(e,t="Argonaut Papers"){return ut(e,t)}async function un(e,t,o="Argonaut Papers"){return gt(e,t,o)}async function ps(){console.log("[GitHub Gist] Loading gist options for load selector");try{let e=await Ut();if(H){if(H.innerHTML="",e.length===0){console.log("[GitHub Gist] No gists found"),H.innerHTML='<option value="">No gists found</option>';return}e.forEach(t=>{let o=document.createElement("option");o.value=t.id;let n=t.description||Object.keys(t.files)[0]||"Unnamed gist";o.textContent=n,H.appendChild(o)}),console.log("[GitHub Gist] Loaded",e.length,"gist options for load selector")}}catch(e){console.error("[GitHub Gist] Error loading gists for load selector:",e),H&&(H.innerHTML='<option value="">Failed to load gists</option>')}}async function gn(){console.log("[GitHub Gist] Loading gist options for save selector");try{let e=await Ut();if(N){N.innerHTML="";let t=document.createElement("option");if(t.value="new",t.textContent="(new gist)",N.appendChild(t),e.length===0){console.log("[GitHub Gist] No existing gists found");return}e.forEach(o=>{let n=document.createElement("option");n.value=o.id;let s=o.description||Object.keys(o.files)[0]||"Unnamed gist";n.textContent=s,N.appendChild(n)}),console.log("[GitHub Gist] Loaded",e.length,"gist options for save selector")}}catch(e){console.error("[GitHub Gist] Error loading gists for save selector:",e),N&&(N.innerHTML='<option value="">Failed to load gists</option>')}}async function fn(){console.log("[GitHub Gist] Loading from gist collection");let e=H.value;if(!e||e==="Loading gists..."||e==="No gists found"||e==="Failed to load gists"){console.log("[GitHub Gist] Invalid gist selected");let{showError:n}=await Promise.resolve().then(()=>(g(),u));n("Please select a gist to load from");return}console.log("[GitHub Gist] Loading from gist:",e),W.classList.add("loading");let{showStatus:t,hideStatus:o}=await Promise.resolve().then(()=>(g(),u));t("Loading from Gist...");try{let n=await dn(e),s=Object.values(n.files).find(I=>I.filename==="papers.json");if(!s){console.log("[GitHub Gist] No papers.json found in gist");let{showError:I}=await Promise.resolve().then(()=>(g(),u));I("Selected gist does not contain a papers.json file");let{hideStatus:x}=await Promise.resolve().then(()=>(g(),u));x(),W.classList.remove("loading");return}let r=JSON.parse(s.content);console.log("[GitHub Gist] Loaded",Object.keys(r).length,"papers from gist");let{clearCurrentData:c}=await Promise.resolve().then(()=>(g(),u));c();let{store:i}=await Promise.resolve().then(()=>(C(),nt));i.set({papersData:r});let{processPapers:d}=await Promise.resolve().then(()=>(E(),w)),p=await d(r),{renderPapers:l}=await Promise.resolve().then(()=>(E(),w));l(p),loadJsonSection.style.display="none",saveJsonSection.style.display="block",exportResetSection.style.display="block",papersSection.style.display="block",t(`Loaded ${Object.keys(r).length} papers from Gist`),setTimeout(o,3e3),console.log("[GitHub Gist] Successfully loaded papers from gist:",e)}catch(n){console.error("[GitHub Gist] Error loading from gist:",n);let{showError:s}=await Promise.resolve().then(()=>(g(),u));s("Error loading from Gist: "+n.message);let{hideStatus:r}=await Promise.resolve().then(()=>(g(),u));r()}finally{W.classList.remove("loading")}}async function mn(){console.log("[GitHub Gist] Saving papers to gist from Save JSON Collection");let e=N.value;if(!e||e==="Loading gists..."||e==="No gists found"||e==="Failed to load gists"){console.log("[GitHub Gist] Invalid gist selected");let{showError:o}=await Promise.resolve().then(()=>(g(),u));o("Please select a gist to save to");return}q.classList.add("loading");let{showStatus:t}=await Promise.resolve().then(()=>(g(),u));t("Saving to Gist...");try{let{state:o}=await Promise.resolve().then(()=>(C(),nt));if(!o.papersData||Object.keys(o.papersData).length===0){console.log("[GitHub Gist] No papers to save");let{showError:i}=await Promise.resolve().then(()=>(g(),u));i("No papers to save");let{hideStatus:d}=await Promise.resolve().then(()=>(g(),u));d(),q.classList.remove("loading");return}let n=jt?jt.value:"full",s=o.papersData;if(n==="light"){s={};for(let[i,d]of Object.entries(o.papersData))s[i]={_doi:d._doi,_comments:d._comments||[],_tags:d._tags||[],_alsoread:d._alsoread||[]}}let c={"papers.json":{content:JSON.stringify(s,null,2)}};if(console.log("[GitHub Gist] Saving",Object.keys(s).length,"papers"),e==="new"){console.log("[GitHub Gist] Creating new gist");let i=prompt("Enter a name for your new gist:","Argonaut Papers");if(i===null){let{hideStatus:I}=await Promise.resolve().then(()=>(g(),u));I(),q.classList.remove("loading");return}let d=i.trim()||"Argonaut Papers",p=await pn(c,d);console.log("[GitHub Gist] Created gist:",p.id);let{showStatus:l}=await Promise.resolve().then(()=>(g(),u));l("Created new Gist successfully"),await gn()}else{console.log("[GitHub Gist] Updating existing gist:",e),await un(e,c),console.log("[GitHub Gist] Updated gist:",e);let{showStatus:i}=await Promise.resolve().then(()=>(g(),u));i("Saved to Gist successfully")}setTimeout(async()=>{let{hideStatus:i}=await Promise.resolve().then(()=>(g(),u));i()},3e3)}catch(o){console.error("[GitHub Gist] Error saving to gist:",o);let{showError:n}=await Promise.resolve().then(()=>(g(),u));n("Error saving to Gist: "+o.message);let{hideStatus:s}=await Promise.resolve().then(()=>(g(),u));s()}finally{q.classList.remove("loading")}}var H,N,W,q,ls,ds,jt,ce=y(()=>{Ge();L()});var hn={};$(hn,{initSaveOptions:()=>le,updateSaveOptionUI:()=>X});function X(e){console.log("updateSaveOptionUI: selectedValue =",e),document.querySelectorAll(".save-section__option").forEach(o=>{o.classList.remove("save-section__option--active");let n=o.querySelector(".save-section__option-content");n&&(n.style.display="none")});let t=document.querySelector(`.save-section__option[data-save="${e}"]`);if(console.log("updateSaveOptionUI: selectedOption =",t),t){t.classList.add("save-section__option--active");let o=t.querySelector(".save-section__option-content");console.log("updateSaveOptionUI: selectedContent =",o),o&&(o.style.display="block"),e==="gist"&&B()&&(Promise.resolve().then(()=>(ce(),ie)).then(({loadGistOptionsForSaveSelector:n})=>{n()}),Promise.resolve().then(()=>(Y(),je)).then(({updateSaveGistVisibility:n})=>{n()}))}}function le(){let e=document.querySelector('input[name="saveMethod"]:checked');if(console.log("initSaveOptions: selectedRadio =",e?.id),e)X(e.value);else{let t=document.getElementById("saveMethodFile");t&&(t.checked=!0,X("file"))}}var de=y(()=>{Y()});var Ft={};$(Ft,{closeTagDialog:()=>Q,hasUnsavedChanges:()=>Ue,initTagEditorDOM:()=>Me,openTagDialog:()=>He,toggleTag:()=>bn,updateExportButtonStates:()=>pe});function Me(){Ht=h("exportBibtexTaggedBtn")}function pe(){Ht&&(Ht.disabled=a.selectedTags.size===0)}function bn(e){let t=[...a.selectedTags],o=t.indexOf(e);o>-1?t.splice(o,1):t.push(e),S.setSelectedTags(t),Promise.resolve().then(()=>(E(),w)).then(({applyTagFilter:n})=>{n(),pe()})}function Ue(){let e=a.papersData[a.currentEditingKey];if(!e)return!1;let t=e._tags||[],o=[...a.tentativeTags];if(t.length!==o.length)return!0;for(let n=0;n<t.length;n++)if(t[n]!==o[n])return!0;return!1}function He(e){if(console.log("openTagDialog called with key:",e),a.currentEditingKey!==null&&a.currentEditingKey!==e){if(Ue()&&!confirm("You have unsaved changes. Discard them?"))return;Q()}S.set({currentEditingKey:e});let t=a.papersData[e];if(!t){console.error("Paper not found for key:",e);return}S.set({tentativeTags:[],tentativeTagsRemoved:[]}),(t._tags||[]).forEach(r=>{let c=typeof r=="object"?JSON.stringify(r):String(r);a.tentativeTags.push(c)});let n=document.querySelector(`.paper[data-key="${e}"]`);if(n||(n=document.querySelector(`.paper-card[data-key="${e}"]`)),!n){console.error("Card not found for key:",e);return}let s=n.querySelector(".tags");if(s||(s=n.querySelector(".tags-container")),s||(s=n.querySelector('[class*="tags"]')),!s){console.error("tags not found for key:",e);return}s.classList.add("tags--editing"),s.dataset.originalContent=s.innerHTML,Nt(s)}function Nt(e){console.log("renderInlineTagEditor called");let t="";a.tentativeTags.length===0&&a.tentativeTagsRemoved.length===0?t='<p class="tag-editor__empty">No tags yet. Add your first tag above!</p>':(a.tentativeTags.forEach(s=>{t+=`<button type="button" class="tag-editor__item" data-tag="${s}" aria-label="Remove tag: ${s}">${s} <span class="tag-editor__remove">\xD7</span></button>`}),a.tentativeTagsRemoved.forEach(s=>{t+=`<button type="button" class="tag-editor__item tag-editor__item--removed" data-tag="${s}" aria-label="Restore tag: ${s}">${s} <span class="tag-editor__restore">+</span></button>`}));let o=`
        <div class="tag-editor">
            <div class="tag-editor__add">
                <input type="text" class="tag-editor__input" placeholder="Add new tag..." aria-label="New tag name">
                <button type="button" class="tag-editor__add-btn">Add</button>
            </div>
            <div class="tag-editor__list" role="list" aria-label="Tags for this paper">
                ${t}
            </div>
            <div class="tag-editor__buttons">
                <button type="button" class="tag-editor__cancel">Cancel</button>
                <button type="button" class="tag-editor__save">Save Tag Changes</button>
            </div>
        </div>
    `;e.innerHTML=o;let n=e.querySelector(".tag-editor__input");n&&n.focus(),us(e)}function us(e){console.log("setupInlineEditorListeners called");let t=e.querySelector(".tag-editor__input"),o=e.querySelector(".tag-editor__add-btn"),n=e.querySelector(".tag-editor__cancel"),s=e.querySelector(".tag-editor__save");console.log("Elements found:",{input:t,addBtn:o,cancelBtn:n,saveBtn:s}),o?o.addEventListener("click",r=>{r.stopPropagation(),yn(e)}):console.error("tag-editor__add-btn not found!"),t&&t.addEventListener("keydown",r=>{r.key==="Enter"&&(r.preventDefault(),yn(e))}),n&&n.addEventListener("click",()=>{Ue()?confirm("You have unsaved changes. Discard them?")&&(Q(),Promise.resolve().then(()=>(E(),w)).then(({applyTagFilter:r})=>{r()})):(Q(),Promise.resolve().then(()=>(E(),w)).then(({applyTagFilter:r})=>{r()}))}),s&&s.addEventListener("click",gs),e.querySelectorAll(".tag-editor__item").forEach(r=>{r.addEventListener("click",c=>{c.stopPropagation();let i=r.dataset.tag;if(r.classList.contains("tag-editor__item--removed")){let p=a.tentativeTagsRemoved.indexOf(i);p>-1&&(a.tentativeTagsRemoved.splice(p,1),a.tentativeTags.push(i))}else{let p=a.tentativeTags.indexOf(i);p>-1&&(a.tentativeTags.splice(p,1),a.tentativeTagsRemoved.push(i))}Nt(e)})})}function yn(e){let t=e.querySelector(".tag-editor__input");if(!t)return;let o=t.value.trim();if(!o)return;if(a.tentativeTags.includes(o)||a.tentativeTagsRemoved.includes(o)){b("Tag already exists");return}a.tentativeTags.push(o),t.value="",Nt(e);let n=e.querySelector(".tag-editor__input");n&&n.focus()}function Q({restoreContent:e=!0}={}){if(a.currentEditingKey===null)return;let t=document.querySelector(`.paper[data-key="${a.currentEditingKey}"]`);if(t||(t=document.querySelector(`.paper-card[data-key="${a.currentEditingKey}"]`)),t){let o=t.querySelector(".tags-container");o&&(o.classList.remove("editing"),e&&o.dataset.originalContent?(o.innerHTML=o.dataset.originalContent,delete o.dataset.originalContent):e||delete o.dataset.originalContent)}S.set({currentEditingKey:null,tentativeTags:[],tentativeTagsRemoved:[]})}function gs(){if(!a.currentEditingKey)return;let e=a.papersData[a.currentEditingKey],t=[...a.tentativeTags],o=e._tags||[],n=o.filter(c=>!t.includes(c)),s=t.filter(c=>!o.includes(c)),r=`Save tag changes for "${e.title||a.currentEditingKey}"?

`;if(s.length>0&&(r+=`Adding: ${s.join(", ")}
`),n.length>0&&(r+=`Removing: ${n.join(", ")}
`),s.length===0&&n.length===0&&(r+="No changes to tags."),r+=`

This action cannot be undone.`,confirm(r)){e._tags=t;let c=a.processedPapersData.find(i=>i.key===a.currentEditingKey);c&&(c.paper=a.papersData[a.currentEditingKey]),Promise.resolve().then(()=>(E(),w)).then(({applyTagFilter:i})=>{i()}),k("Tags updated successfully")}Q({restoreContent:!1})}var Ht,ue=y(()=>{C();U();L()});var Sn={};$(Sn,{saveComment:()=>vn});function vn(e,t){if(!a.papersData[e])return;let o=a.papersData[e];if((o._comments||"")!==t){o._comments=t;let s=a.processedPapersData.find(r=>r.key===e);s&&(s.paper=a.papersData[e]),console.log(`Comment saved for "${e}"`)}}var Jt=y(()=>{C()});function Kt(){T=h("onboardingModal"),fe=h("onboardingBackBtn"),me=h("onboardingNextBtn"),he=h("onboardingCompleteBtn"),Xt=document.querySelectorAll(".onboarding__step"),ye=document.querySelectorAll(".onboarding__dot")}function xn(e,t,o){let n=new Date;n.setTime(n.getTime()+o*24*60*60*1e3),document.cookie=`${e}=${t};expires=${n.toUTCString()};path=/;SameSite=Lax`}function wn(e){let t=`${e}=`,o=document.cookie.split(";");for(let n=0;n<o.length;n++){let s=o[n];for(;s.charAt(0)===" ";)s=s.substring(1,s.length);if(s.indexOf(t)===0)return s.substring(t.length,s.length)}return null}function En(){return wn("argonaut_onboarding_complete")==="true"}function _n(){xn("argonaut_onboarding_complete","true",365)}function zt(){A=0,be(),T&&(T.classList.add("onboarding--active"),T.setAttribute("aria-hidden","false"),document.body.style.overflow="hidden")}function ge(){T&&(T.classList.remove("onboarding--active"),T.setAttribute("aria-hidden","true"),document.body.style.overflow="")}function be(){T&&(Xt&&Xt.forEach((e,t)=>{e.classList.toggle("onboarding__step--active",t===A)}),ye&&ye.forEach((e,t)=>{let o=t===A;e.classList.toggle("onboarding__dot--active",o),e.setAttribute("aria-selected",o.toString()),e.setAttribute("tabindex",o?"0":"-1")}),fe&&(fe.style.visibility=A===0?"hidden":"visible"),me&&(me.style.display=A===qt-1?"none":"block"),he&&(he.style.display=A===qt-1?"block":"none"),A===0&&T.focus())}function kn(){A<qt-1&&(A++,be())}function Bn(){A>0&&(A--,be())}function In(e){A=e,be()}function Ln(){_n(),ge()}function Vt(){En()||setTimeout(()=>{zt()},500)}function Wt(e,t){e&&e.addEventListener("click",()=>ge()),me&&me.addEventListener("click",kn),fe&&fe.addEventListener("click",Bn),he&&he.addEventListener("click",Ln),t&&t.addEventListener("click",zt),ye&&ye.forEach(o=>{o.addEventListener("click",()=>{In(parseInt(o.dataset.step))})}),document.addEventListener("keydown",o=>{o.key==="Escape"&&T&&T.classList.contains("onboarding--active")&&ge()}),T&&T.addEventListener("click",o=>{o.target===T&&ge()})}var A,qt,T,fe,me,he,Xt,ye,Yt=y(()=>{L();A=0,qt=6});var u={};$(u,{clearCurrentData:()=>an,closeTagDialog:()=>Q,completeOnboarding:()=>Ln,escapeHtml:()=>is,exportBibTeX:()=>Pt,exportBibTeXTagged:()=>Rt,exportJSON:()=>Gt,exportJSONLight:()=>cs,getCookie:()=>wn,getMimeTypeDescription:()=>cn,getMimeTypeExtensions:()=>ln,getStoredTheme:()=>rn,getSystemPreference:()=>sn,goToStep:()=>In,hasCompletedOnboarding:()=>En,hasUnsavedChanges:()=>Ue,hideError:()=>mt,hideOnboarding:()=>ge,hideStatus:()=>V,initDOM:()=>po,initEventListeners:()=>uo,initExportDOM:()=>At,initInputOptions:()=>Je,initInputOptionsDOM:()=>Fe,initLoadDOM:()=>go,initNotificationsDOM:()=>ft,initOnboarding:()=>Vt,initOnboardingDOM:()=>Kt,initOnboardingListeners:()=>Wt,initSaveOptions:()=>le,initStorageDOM:()=>Lt,initTagEditorDOM:()=>Me,initTheme:()=>Et,initThemeDOM:()=>xt,initThemeListener:()=>_t,loadDefault:()=>An,loadFromFile:()=>On,loadFromStorage:()=>Ct,loadFromUrl:()=>Dn,loadPapers:()=>ee,markOnboardingComplete:()=>_n,nextStep:()=>kn,openTagDialog:()=>He,prevStep:()=>Bn,saveComment:()=>vn,saveFileWithPicker:()=>ae,saveToStorage:()=>Tt,setCookie:()=>xn,setTheme:()=>$e,showError:()=>b,showOnboarding:()=>zt,showStatus:()=>k,toggleTag:()=>bn,updateExportButtonStates:()=>pe,updateInputOptionUI:()=>z,updateOnboardingUI:()=>be,updateSaveOptionUI:()=>X,updateThemeIcons:()=>wt});function po(){ft(),xt(),Lt(),At(),go(),Fe(),Me(),Kt();let e=M("loadJsonSection","saveJsonSection","papersSection","exportResetSection","papersList","fileInput","urlInput","loadUrlBtn","loadFromStorageBtn","loadNewBtn","saveToStorageBtn","exportJsonBtn","exportBibtexAllBtn","exportBibtexTaggedBtn","jsonFormatSelector","closeOnboardingBtn","showOnboardingBtn");Qt=e.loadJsonSection,Zt=e.saveJsonSection,eo=e.papersSection,to=e.exportResetSection,K=e.papersList,Z=e.fileInput,oo=e.urlInput,no=e.loadUrlBtn,so=e.loadFromStorageBtn,ro=e.loadNewBtn,ao=e.saveToStorageBtn,io=e.exportJsonBtn,co=e.exportBibtexAllBtn,lo=e.exportBibtexTaggedBtn,fs=e.jsonFormatSelector,Tn=e.closeOnboardingBtn,Cn=e.showOnboardingBtn,pe(),console.log("[UI] DOM elements initialized")}function uo(){console.log("[UI] Initializing event listeners"),_t(),document.querySelectorAll('input[name="inputMethod"]').forEach(e=>{e.addEventListener("change",t=>{z(t.target.value)})}),document.querySelectorAll('input[name="saveMethod"]').forEach(e=>{e.addEventListener("change",()=>X(e.value))}),Z&&Z.addEventListener("change",()=>{Z.files[0]&&ee("file")}),no&&no.addEventListener("click",()=>ee("url")),so&&so.addEventListener("click",Ct),ro&&ro.addEventListener("click",()=>{confirm(`Are you sure you want to reset all papers?

This will clear:
\u2022 All papers
\u2022 All comments
\u2022 All tags
\u2022 Any unsaved changes

This action cannot be undone.`)&&(S.setSelectedTags([]),S.set({papersData:{},processedPapersData:[]}),eo&&(eo.style.display="none"),Zt&&(Zt.style.display="none"),to&&(to.style.display="none"),Qt&&(Qt.style.display="block"),K&&(K.innerHTML=""),Z&&(Z.value=""),oo&&(oo.value="https://gist.githubusercontent.com/srtee/04ee671f6f27d64de800f00eb9280a21/raw/papers.json"),V())}),ao&&ao.addEventListener("click",Tt),io&&(console.log("[UI] Export JSON button found, adding click handler"),io.addEventListener("click",()=>{console.log("[UI] Export JSON button clicked"),Gt()})),co&&co.addEventListener("click",Pt),lo&&lo.addEventListener("click",Rt),Wt(Tn,Cn),K&&K.addEventListener("click",e=>{let t=e.target.closest(".tag-edit-btn");if(t){e.stopPropagation();let o=t.dataset.key;console.log("Edit button clicked, key:",o),He(o)}}),document.addEventListener("keydown",async e=>{if(e.key==="Escape"&&a.currentEditingKey!==null){let{hasUnsavedChanges:t,closeTagDialog:o}=await Promise.resolve().then(()=>(ue(),Ft));t()?confirm("You have unsaved changes. Discard them?")&&(o(),Promise.resolve().then(()=>(E(),w)).then(({applyTagFilter:n})=>{n()})):(o(),Promise.resolve().then(()=>(E(),w)).then(({applyTagFilter:n})=>{n()}))}}),document.addEventListener("click",e=>{if(a.currentEditingKey!==null){let t=document.querySelector(".tag-editor");t&&!t.contains(e.target)&&Promise.resolve().then(()=>(ue(),Ft)).then(({hasUnsavedChanges:o,closeTagDialog:n})=>{o()?confirm("You have unsaved changes. Discard them?")&&(n(),Promise.resolve().then(()=>(E(),w)).then(({applyTagFilter:s})=>{s()})):(n(),Promise.resolve().then(()=>(E(),w)).then(({applyTagFilter:s})=>{s()}))})}}),K&&K.addEventListener("blur",e=>{if(e.target.classList.contains("comments")){let t=e.target.dataset.key,o=e.target.value;Promise.resolve().then(()=>(Jt(),Sn)).then(({saveComment:n})=>{n(t,o)})}},!0),console.log("[UI] Event listeners initialized")}var Qt,Zt,eo,to,K,Z,oo,no,so,ro,ao,io,co,lo,fs,Tn,Cn,g=y(()=>{C();L();kt();U();Ot();$t();Ne();qe();de();ue();Jt();Yt();de();kt();U();Ot();$t();Ne();qe();de();ue();Yt();U()});var w={};$(w,{addPagesToBibTeX:()=>hs,addPaperByDoi:()=>yo,applyTagFilter:()=>xo,createPaperCard:()=>Rn,displayPapers:()=>ys,fetchAbstract:()=>vo,fetchAbstractFromCrossref:()=>Le,fetchAbstractFromSemanticScholar:()=>Ie,fetchBibTeX:()=>ne,fetchPagesFromCrossref:()=>Te,formatAuthors:()=>ho,generateDefaultKey:()=>Pn,hasSelectedTag:()=>Ke,initDOM:()=>bo,initEventListeners:()=>wo,parseBibTeX:()=>So,processPapers:()=>$n,renderPapers:()=>jn,updateTagVisuals:()=>Mn});function bo(){let e=M("papersList","loadJsonSection","saveJsonSection","exportResetSection","papersSection","doiInput","doiKeyInput","addDoiBtn","status","exportBibtexTaggedBtn");Xe=e.papersList,ze=e.loadJsonSection,Ve=e.saveJsonSection,We=e.exportResetSection,Ye=e.papersSection,ve=e.doiInput,fo=e.doiKeyInput,mo=e.addDoiBtn,Gn=e.status,ms=e.exportBibtexTaggedBtn,console.log("[Papers] DOM elements initialized")}async function vo(e){let t=await Ie(e);return t||(t=await Le(e),t)}function hs(e,t){if(!t)return e;let o=/pages\s*=\s*(?:\{([^}]*)\}|"([^"]*)")/i,n=e.match(o);if(n){let s=n[1]||n[2];return e.replace(n[0],`pages = {${t}}`)}else{let s=/year\s*=\s*(?:\{([^}]*)\}|"([^"]*)")/i,r=e.match(s);if(r)return e.replace(r[0],`${r[0]},
  pages = {${t}}`);{let c=/(\w+)\s*=\s*(?:\{([^}]*)\}|"([^"]*)")/,i=e.match(c);if(i)return e.replace(i[0],`${i[0]},
  pages = {${t}}`)}}return e}function So(e){let t={title:"",author:"",journal:"",year:"",month:"",volume:"",number:"",pages:""},o=/(\w+)\s*=\s*(?:\{([^}]*)\}|"([^"]*)")/g,n;for(;(n=o.exec(e))!==null;){let s=n[1].toLowerCase(),r=n[2]||n[3];t.hasOwnProperty(s)&&(t[s]=r)}return t}function ho(e){return e?e.split(/\s+and\s+/i).map(t=>{let o=t.split(",").map(n=>n.trim()).filter(n=>n);return o.length>=2?`${o[1]} ${o[0]}`:t.trim()}).join(", "):"Unknown authors"}function Pn(e){let t=e.author||"",o=e.year||"",r=((t.split(/\s+and\s+/i)[0]||"").split(",")[0]?.trim()||"Unknown").replace(/[^a-zA-Z]/g,""),c=r.charAt(0).toUpperCase()+r.slice(1).toLowerCase()+o,i=c,d=1,p=Object.keys(a.papersData);for(;p.includes(i);)i=c+String.fromCharCode(96+d),d++;return i}async function yo(){let e=ve.value.trim(),t=fo.value.trim();if(!e){let{showError:n}=await Promise.resolve().then(()=>(g(),u));n("Please enter a DOI or URL");return}let o=extractDOI(e);if(!o){let{showError:n}=await Promise.resolve().then(()=>(g(),u));n("Could not extract a valid DOI from the input. Please enter a valid DOI (e.g., 10.xxxx/xxxx) or a URL containing a DOI.");return}try{let{showStatus:n}=await Promise.resolve().then(()=>(g(),u));n(`Fetching paper: ${o}...`);let s=await ne(o);if(!s){let{showError:p}=await Promise.resolve().then(()=>(g(),u));p("Failed to fetch BibTeX for this DOI");return}let r=So(s),c=t||Pn(r);if(a.papersData[c]&&!t){let{showError:p}=await Promise.resolve().then(()=>(g(),u));p(`Paper "${c}" already exists. Please provide a custom key or use a different DOI.`);return}else if(a.papersData[c]&&t&&!confirm(`The key "${c}" already exists. Do you want to overwrite the existing entry?`)){let{hideStatus:p}=await Promise.resolve().then(()=>(g(),u));p();return}let i=await vo(o);S.set({papersData:{...a.papersData,[c]:{_doi:o,...r.title&&{title:r.title},...r.author&&{author:r.author},...r.journal&&{journal:r.journal},...r.year&&{year:r.year},...r.volume&&{volume:r.volume},...r.number&&{number:r.number},...r.pages&&{pages:r.pages}}}});let d={key:c,paper:{_doi:o,...r.title&&{title:r.title},...r.author&&{author:r.author},...r.journal&&{journal:r.journal},...r.year&&{year:r.year},...r.volume&&{volume:r.volume},...r.number&&{number:r.number},...r.pages&&{pages:r.pages}},bibInfo:{title:r.title||c,...r},abstract:i};S.set({processedPapersData:[...a.processedPapersData,d]}),xo(),Object.keys(a.papersData).length===1&&(ze.style.display="none",Ve.style.display="block",We.style.display="block",Ye.style.display="block"),ve.value="",fo.value="",n(`Paper "${c}" added successfully`),setTimeout(()=>{let p=document.querySelector(`.paper[data-key="${c}"]`);p&&(p.scrollIntoView({behavior:"smooth",block:"center"}),p.classList.add("paper--highlight"),setTimeout(()=>p.classList.remove("paper--highlight"),2e3))},100)}catch(n){console.error("Error adding paper:",n);let{showError:s}=await Promise.resolve().then(()=>(g(),u));s("Error adding paper: "+n.message)}}function Rn(e,t,o,n){let s=document.createElement("article");s.className="paper",s.dataset.key=e;let r=f=>{if(!f)return"";let m=document.createElement("div");return m.textContent=f,m.innerHTML},c=(t._tags||[]).map(f=>`<button type="button" class="tag" data-tag="${f}" aria-pressed="false" tabindex="0">${f}</button>`).join(""),i=(t._alsoread||[]).map(f=>`<button type="button" class="also-read__link" data-ref="${f}" tabindex="0" aria-label="View paper: ${f}">${f}</button>`).join(""),d=`<textarea class="comments" placeholder="Add your notes..." data-key="${e}" aria-label="Notes for this paper">${t._comments||""}</textarea>`,p=n?`<div class="abstract__content">${r(n)}</div>`:'<p class="abstract__empty">No abstract available</p>',l=[];ho(o.author)&&l.push(`<span class="citation__authors">${ho(o.author)}</span>`),r(o.journal)&&l.push(`<span class="citation__journal">${r(o.journal)}</span>`),o.year&&l.push(`<span class="citation__year">${o.year}</span>`),o.volume&&l.push(`<span class="citation__volume">Vol. ${o.volume}</span>`),o.number&&l.push(`<span class="citation__number">No. ${o.number}</span>`),o.pages&&l.push(`<span class="citation__pages">pp. ${o.pages}</span>`),t._doi&&l.push(`<a href="https://doi.org/${t._doi}" target="_blank" rel="noopener noreferrer" class="citation__link">DOI: ${t._doi}</a>`);let I=l.join(" ");s.innerHTML=`
        <div class="paper__header">
            <h3 class="paper__title">
                <button class="key-edit-btn" aria-label="Edit paper key" type="button" data-key="${e}">
                    <svg class="key-edit-btn__icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                        <path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"></path>
                    </svg>
                </button>
                <span class="paper__title-text">${r(o.title||e)}</span>
            </h3>
            <div class="key-editor" data-key="${e}">
                <div class="key-editor__content">
                    <label class="key-editor__label">Current key:</label>
                    <span class="key-editor__current">${r(e)}</span>
                    <div class="key-editor__input-group">
                        <input type="text" class="key-editor__input" placeholder="New key..." aria-label="New paper key">
                        <button type="button" class="key-editor__save">Rename</button>
                    </div>
                    <button type="button" class="key-editor__delete">Delete Paper</button>
                </div>
            </div>
        </div>
        <p class="citation">${I}</p>
        ${d}
        <div class="tags">
            <button class="tag-edit-btn" aria-label="Edit tags" type="button" data-key="${e}">
                <svg class="tag-edit-btn__icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                    <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path>
                </svg>
            </button>
            ${c}
        </div>
        ${i?`<div class="also-read" role="group" aria-label="Also read papers"><span class="also-read__label">Also read:</span> ${i}</div>`:""}
        <button class="abstract-toggle" aria-expanded="false" aria-label="Toggle abstract" type="button">
            <svg class="abstract-toggle__icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                <path d="M6 9l6 6 6-6"/>
            </svg>
            Abstract
        </button>
        <div class="abstract" aria-hidden="true">
            ${p}
        </div>
    `;let x=s.querySelector(".key-edit-btn"),O=s.querySelector(".key-editor");x.addEventListener("click",f=>{f.stopPropagation();let m=O.classList.contains("key-editor--open");document.querySelectorAll(".key-editor--open").forEach(v=>{v!==O&&v.classList.remove("key-editor--open")}),O.classList.toggle("key-editor--open")});let jo=O.querySelector(".key-editor__save"),ot=O.querySelector(".key-editor__input"),Vn=O.querySelector(".key-editor__delete");jo.addEventListener("click",async f=>{f.stopPropagation();let m=ot.value.trim();if(!m){let{showError:_}=await Promise.resolve().then(()=>(g(),u));_("Please enter a new key");return}if(m===e){O.classList.remove("key-editor--open");return}if(a.papersData[m]){let{showError:_}=await Promise.resolve().then(()=>(g(),u));_(`Key "${m}" already exists`);return}let v=a.papersData[e];delete a.papersData[e],a.papersData[m]=v,tn(e,m);let G=a.processedPapersData.find(_=>_.key===e);G&&(G.key=m,G.paper=v),Object.keys(a.papersData).forEach(_=>{let j=a.papersData[_];j._alsoread&&(j._alsoread=j._alsoread.map(Uo=>Uo===e?m:Uo))}),a.processedPapersData.forEach(_=>{_.paper._alsoread&&(_.paper._alsoread=_.paper._alsoread.map(j=>j===e?m:j))}),s.dataset.key=m,x.dataset.key=m,O.dataset.key=m,O.querySelector(".key-editor__current").textContent=m,s.querySelector(".comments").dataset.key=m,s.querySelector(".tag-edit-btn").dataset.key=m,ot.value="",O.classList.remove("key-editor--open");let{showStatus:P}=await Promise.resolve().then(()=>(g(),u));P(`Paper renamed to "${m}"`)}),ot.addEventListener("keydown",f=>{f.key==="Enter"&&(f.preventDefault(),jo.click())}),Vn.addEventListener("click",async f=>{f.stopPropagation();let m=o.title||e;if(!confirm(`Are you sure you want to delete "${m}"?

This will remove the paper from your bibliography. This action cannot be undone.`))return;delete a.papersData[e],on(e);let v=a.processedPapersData.findIndex(P=>P.key===e);v>-1&&a.processedPapersData.splice(v,1),Object.keys(a.papersData).forEach(P=>{let _=a.papersData[P];_._alsoread&&(_._alsoread=_._alsoread.filter(j=>j!==e))}),a.processedPapersData.forEach(P=>{P.paper._alsoread&&(P.paper._alsoread=P.paper._alsoread.filter(_=>_!==e))}),s.remove(),Object.keys(a.papersData).length===0&&(ze.style.display="block",Ve.style.display="none",We.style.display="none",Ye.style.display="none");let{showStatus:G}=await Promise.resolve().then(()=>(g(),u));G(`Paper "${m}" deleted`)}),document.addEventListener("click",f=>{!s.contains(f.target)&&O.classList.contains("key-editor--open")&&O.classList.remove("key-editor--open")});let Ee=s.querySelector(".abstract-toggle"),Mo=s.querySelector(".abstract");return Ee.addEventListener("click",()=>{let f=Ee.getAttribute("aria-expanded")==="true";Ee.setAttribute("aria-expanded",!f),Mo.classList.toggle("abstract--expanded"),Mo.setAttribute("aria-hidden",f),Ee.querySelector("svg").style.transform=f?"rotate(0deg)":"rotate(180deg)"}),s.querySelectorAll(".also-read__link").forEach(f=>{let m=()=>{let v=f.dataset.ref,G=document.querySelector(`.paper[data-key="${v}"]`);G?(G.scrollIntoView({behavior:"smooth",block:"center"}),G.classList.add("paper--highlight"),G.focus(),setTimeout(()=>G.classList.remove("paper--highlight"),2e3)):Promise.resolve().then(()=>(g(),u)).then(({showError:P})=>{P(`Paper "${v}" not found in current view`)})};f.addEventListener("click",m),f.addEventListener("keydown",v=>{(v.key==="Enter"||v.key===" ")&&(v.preventDefault(),m())})}),s.querySelectorAll(".tag").forEach(f=>{let m=()=>{Promise.resolve().then(()=>(g(),u)).then(({toggleTag:v})=>{v(f.dataset.tag)})};f.addEventListener("click",m),f.addEventListener("keydown",v=>{(v.key==="Enter"||v.key===" ")&&(v.preventDefault(),m())})}),s}async function $n(e,t={}){let{useCache:o=!0}=t;S.set({papersData:e});let n=Object.entries(e),{showStatus:s}=await Promise.resolve().then(()=>(g(),u));s(`Processing ${n.length} papers...`),await new Promise(c=>setTimeout(c,0));let r=[];for(let c=0;c<n.length;c++){let[i,d]=n[c];Gn.textContent=`Fetching ${c+1} of ${n.length}: ${i}`,await new Promise(l=>setTimeout(l,0));let p={key:i,paper:d,bibInfo:{title:i},abstract:null};if(o){let l=Zo(i);if(l&&l.bibInfo){console.log("[Papers] Using cached data for:",i),p.bibInfo=l.bibInfo,p.abstract=l.abstract;let I=l.bibInfo&&l.bibInfo.pages,x=l.abstract;if(d._doi&&!I)console.log("[Papers] Cache missing pages, fetching fresh data for:",i);else{r.push(p);continue}}}if(d._doi){let l=await ne(d._doi);if(l){p.bibInfo=So(l);let x=p.bibInfo.pages;x||(x=await Te(d._doi),x&&(p.bibInfo.pages=x))}let I=await vo(d._doi);I&&(p.abstract=I),o&&en(i,{bibtex:l,bibInfo:p.bibInfo,abstract:p.abstract})}r.push(p),c<n.length-1&&await new Promise(l=>setTimeout(l,1e3))}return r}async function ys(){let e=await $n(a.papersData);jn(e),ze.style.display="none",Ye.style.display="block",Ve.style.display="block",We.style.display="block"}function jn(e){S.set({processedPapersData:e}),xo()}function xo(){if(Xe.innerHTML="",a.processedPapersData.length===0){Xe.innerHTML='<p class="no-papers">No papers found in the loaded data.</p>';return}[...a.processedPapersData].sort((t,o)=>{let n=Ke(t.paper),s=Ke(o.paper);return n&&!s?-1:!n&&s?1:0}).forEach(({key:t,paper:o,bibInfo:n,abstract:s})=>{let r=Rn(t,o,n,s);a.selectedTags.size>0&&!Ke(o)&&r.classList.add("paper--dimmed"),Xe.appendChild(r)}),Mn(),Promise.resolve().then(()=>(g(),u)).then(({updateExportButtonStates:t})=>{t()})}function Ke(e){let t=e._tags||[];return a.selectedTags.size===0?!0:t.some(o=>a.selectedTags.has(o))}function Mn(){document.querySelectorAll(".tag").forEach(e=>{let t=e.dataset.tag;a.selectedTags.size===0?(e.classList.remove("tag--selected","tag--deselected"),e.setAttribute("aria-pressed","false")):a.selectedTags.has(t)?(e.classList.add("tag--selected"),e.classList.remove("tag--deselected"),e.setAttribute("aria-pressed","true")):(e.classList.add("tag--deselected"),e.classList.remove("tag--selected"),e.setAttribute("aria-pressed","false"))})}function wo(){console.log("[Papers] Initializing event listeners"),mo&&mo.addEventListener("click",()=>{yo()}),ve&&ve.addEventListener("keydown",e=>{e.key==="Enter"&&(e.preventDefault(),yo())}),console.log("[Papers] Event listeners initialized")}var Xe,ze,Ve,We,Ye,ve,fo,mo,Gn,ms,E=y(()=>{C();L();Ge();nn()});function go(){Se=h("papersList"),Qe=h("fileInput"),Eo=h("urlInput"),_o=h("loadJsonSection"),ko=h("saveJsonSection"),Bo=h("exportResetSection"),Io=h("papersSection")}function On(e){return new Promise((t,o)=>{let n=new FileReader;n.onload=s=>{try{let r=JSON.parse(s.target.result);t(r)}catch{o(new Error("Invalid JSON file"))}},n.onerror=()=>o(new Error("Error reading file")),n.readAsText(e)})}async function Dn(e){try{let t=await fetch(e);if(!t.ok)throw new Error(`Failed to load: ${t.status}`);return await t.json()}catch(t){throw new Error(`Error loading from URL: ${t.message}`)}}async function An(){try{let e=await fetch("papers.json");if(!e.ok)throw new Error("papers.json not found");return await e.json()}catch(e){throw new Error("Error loading default papers: "+e.message)}}async function ee(e){mt(),V(),Se&&(Se.innerHTML='<p class="loading">Loading papers...</p>');try{let t;switch(e){case"file":if(!Qe||!Qe.files[0])throw new Error("Please select a file");k("Loading papers from file..."),t=await On(Qe.files[0]);break;case"url":if(!Eo)throw new Error("URL input not found");let r=Eo.value.trim();if(!r)throw new Error("Please enter a URL");k("Loading papers from URL..."),t=await Dn(r);break;case"default":t=await An();break;default:throw new Error("Invalid input method")}let{processPapers:o}=await Promise.resolve().then(()=>(E(),w)),n=await o(t),{renderPapers:s}=await Promise.resolve().then(()=>(E(),w));s(n),_o&&(_o.style.display="none"),ko&&(ko.style.display="block"),Bo&&(Bo.style.display="block"),Io&&(Io.style.display="block"),k(`Loaded ${n.length} papers successfully`),setTimeout(V,3e3)}catch(t){b(t.message),Se&&(Se.innerHTML="")}}var Se,Qe,Eo,_o,ko,Bo,Io,Ne=y(()=>{U();L()});var Un={};$(Un,{initInputOptions:()=>Je,initInputOptionsDOM:()=>Fe,updateInputOptionUI:()=>z});function Fe(){Lo=h("urlInput")}function z(e){console.log("updateInputOptionUI: selectedValue =",e),document.querySelectorAll(".input-section__option").forEach(o=>{o.classList.remove("input-section__option--active");let n=o.querySelector(".input-section__content");n&&(n.style.display="none")});let t=document.querySelector(`.input-section__option[data-input="${e}"]`);if(console.log("updateInputOptionUI: selectedOption =",t),t){t.classList.add("input-section__option--active");let o=t.querySelector(".input-section__content");console.log("updateInputOptionUI: selectedContent =",o),o&&(o.style.display="block"),e==="gist"&&B()&&(Promise.resolve().then(()=>(ce(),ie)).then(({loadGistOptionsForLoadSelector:n})=>{n()}),Promise.resolve().then(()=>(Y(),je)).then(({updateGistVisibility:n})=>{n()}))}}function Je(){let e=document.querySelector('input[name="inputMethod"]:checked');if(console.log("initInputOptions: selectedRadio =",e?.id),e)z(e.value);else{let t=document.getElementById("inputMethodUrl");t&&(t.checked=!0,z("url"))}bs()}function bs(){let t=new URLSearchParams(window.location.search).get("inputURL");if(t){console.log("[URL Parameter] Found inputURL:",t),Lo&&(Lo.value=t);let o=document.getElementById("inputMethodUrl");o&&(o.checked=!0,z("url")),setTimeout(()=>{ee("url")},100),window.history.replaceState({},document.title,window.location.pathname)}}var Lo,qe=y(()=>{Y();Ne();L()});var je={};$(je,{checkSession:()=>Fn,clearSessionId:()=>Oe,getSessionId:()=>B,initDOM:()=>Ao,initEventListeners:()=>$o,initGitHubAuth:()=>Ro,initiateLogin:()=>Jn,loadGitHubAuth:()=>Kn,logout:()=>qn,restorePapersState:()=>zn,setSessionId:()=>Ce,updateGistRadioState:()=>tt,updateGistVisibility:()=>Po,updateGitHubUI:()=>Xn,updateSaveGistVisibility:()=>Go});function Ao(){let e=M("githubSection","githubNotLoggedIn","githubLoggedIn","githubConnectBtn","githubLogoutBtn","githubUserAvatar","githubUserName","gistConnectedContent","saveGistConnectedContent","loadJsonSection","saveJsonSection","exportResetSection","papersSection");vs=e.githubSection,Ze=e.githubNotLoggedIn,et=e.githubLoggedIn,te=e.githubConnectBtn,oe=e.githubLogoutBtn,To=e.githubUserAvatar,Hn=e.githubUserName,xe=e.gistConnectedContent,we=e.saveGistConnectedContent,Nn=e.loadJsonSection,Co=e.saveJsonSection,Oo=e.exportResetSection,Do=e.papersSection,console.log("[Auth] DOM elements initialized")}async function Fn(){return at()}async function Jn(){console.log("[GitHub Auth] Initiating login, redirecting to GitHub OAuth");let e={hasPapers:Object.keys(a.papersData).length>0,saveJsonVisible:Co?.style.display==="block",exportResetVisible:Oo?.style.display==="block",papersVisible:Do?.style.display==="block",papersData:a.papersData,processedPapersData:a.processedPapersData,selectedTags:Array.from(a.selectedTags)};sessionStorage.setItem("argonaut_oauth_state",JSON.stringify(e)),it()}async function qn(){console.log("[GitHub Auth] Initiating logout"),await ct(),Ze&&(Ze.style.display="block"),et&&(et.style.display="none"),te&&(te.style.display="block"),oe&&(oe.style.display="none"),Po(),Go(),tt(),console.log("[GitHub Auth] UI updated to logged-out state")}function Xn(e){console.log("[GitHub Auth] updateGitHubUI called with user:",e),Ze.style.display="none",et.style.display="flex",te.style.display="none",oe.style.display="inline-block",To.src=e.avatar_url,To.alt=e.login,Hn.textContent=e.login,Po(),Go(),tt(),console.log("[GitHub Auth] UI updated")}function Go(){B()?we&&(we.style.display="flex"):we&&(we.style.display="none")}function tt(){let e=B(),t=document.getElementById("inputMethodGist"),o=document.getElementById("saveMethodGist");if(e)t&&(t.disabled=!1),o&&(o.disabled=!1);else{if(t&&(t.disabled=!0,t.checked)){let n=document.getElementById("inputMethodUrl");n&&(n.checked=!0,Promise.resolve().then(()=>(qe(),Un)).then(({updateInputOptionUI:s})=>{s("url")}))}if(o&&(o.disabled=!0,o.checked)){let n=document.getElementById("saveMethodFile");n&&(n.checked=!0,Promise.resolve().then(()=>(de(),hn)).then(({updateSaveOptionUI:s})=>{s("file")}))}}}function Po(){B()?xe&&(xe.style.display="flex"):xe&&(xe.style.display="none")}async function Kn(){console.log("[GitHub Auth] loadGitHubAuth called");let e=await Fn();if(console.log("[GitHub Auth] Session result:",e),e.authenticated&&e.user){console.log("[GitHub Auth] User authenticated, updating UI"),Xn(e.user);let{loadGistOptionsForLoadSelector:t}=await Promise.resolve().then(()=>(ce(),ie));await t()}else console.log("[GitHub Auth] User not authenticated or no user data"),tt()}async function Ro(){console.log("[GitHub Auth] initGitHubAuth called");let e=new URLSearchParams(window.location.search);console.log("[GitHub Auth] URL params:",Object.fromEntries(e.entries()));let t=e.get("session_id"),o=e.get("auth");if(console.log("[GitHub Auth] Session ID from URL:",t?t.substring(0,10)+"...":"null"),console.log("[GitHub Auth] Auth status from URL:",o),t&&o==="success"){console.log("[GitHub Auth] OAuth callback received, storing session ID"),Ce(t),console.log("[GitHub Auth] Session ID stored:",B()?B().substring(0,10)+"...":"null"),window.history.replaceState({},document.title,window.location.pathname);let{showStatus:n}=await Promise.resolve().then(()=>(g(),u));n("Successfully connected to GitHub");let{hideStatus:s}=await Promise.resolve().then(()=>(g(),u));setTimeout(s,3e3),await zn()}else if(a.papersData&&Object.keys(a.papersData).length>0){let{displayPapers:n}=await Promise.resolve().then(()=>(E(),w));await n()}await Kn()}async function zn(){let e=sessionStorage.getItem("argonaut_oauth_state");if(e)try{let t=JSON.parse(e);if(t.hasPapers){t.papersData&&S.set({papersData:t.papersData}),t.processedPapersData&&S.set({processedPapersData:t.processedPapersData}),t.selectedTags&&S.setSelectedTags(t.selectedTags),t.saveJsonVisible&&(Co.style.display="block"),t.exportResetVisible&&(Oo.style.display="block"),t.papersVisible&&(Do.style.display="block"),Nn.style.display="none";let{displayPapers:o}=await Promise.resolve().then(()=>(E(),w));await o()}sessionStorage.removeItem("argonaut_oauth_state")}catch(t){console.error("[GitHub Auth] Error restoring state:",t)}else if(a.papersData&&Object.keys(a.papersData).length>0){let{displayPapers:t}=await Promise.resolve().then(()=>(E(),w));await t()}}function $o(){console.log("[Auth] Initializing event listeners"),te&&te.addEventListener("click",Jn),oe&&oe.addEventListener("click",qn),console.log("[Auth] Event listeners initialized")}var vs,Ze,et,te,oe,To,Hn,xe,we,Nn,Co,Oo,Do,Y=y(()=>{C();L();Ge()});C();Y();ce();E();g();L();document.addEventListener("DOMContentLoaded",()=>{qo(),po(),Ao(),Mt(),bo(),uo(),wo(),$o(),Et(),Ro(),Je(),le(),Vt()});
